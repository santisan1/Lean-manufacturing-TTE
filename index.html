<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard 5S - Sector Bobinado</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .plant-map-image {
            width: 100%;
            height: auto;
            display: block;
        }


        .marker-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        }

        .marker-desvio-abierto {
            background-color: #ef4444;
        }

        .marker-desvio-cerrado {
            background-color: #22c55e;
        }

        .marker-kaizen-abierto {
            background-color: #a855f7;
        }

        .marker-kaizen-cerrado {
            background-color: #d8b4fe;
        }

        /* Plant map styles */
        .plant-map-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .plant-map-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .map-marker {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all .2s ease;
            z-index: 10;
        }

        .map-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 20;
        }

        .marker-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
        }

        .marker-desvio-abierto {
            background: #ef4444;
        }

        .marker-desvio-cerrado {
            background: #22c55e;
        }

        .marker-kaizen-abierto {
            background: #a855f7;
        }

        .marker-kaizen-cerrado {
            background: #c084fc;
        }

        .map-selector-mode {
            cursor: crosshair;
        }

        .coordinate-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #fe4a00;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: .5;
                transform: translate(-50%, -50%) scale(1.3);
            }
        }

        .tab-active {
            border-bottom-width: 2px;
            border-color: #fe4a00;
            color: #fe4a00;
        }

        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Agregar en el <style> */
        .transition-all {
            transition: all 0.3s ease;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div id="login-screen"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900 transition-all duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üîí</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Acceso Restringido</h2>
                <p class="text-gray-500 text-sm mt-2">Ingresa tus credenciales</p>
            </div>

            <form onsubmit="event.preventDefault(); doLogin();" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Usuario</label>
                    <input type="text" id="username"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all"
                        placeholder="admin" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Contrase√±a</label>
                    <input type="password" id="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>

                <div id="login-error"
                    class="hidden text-red-500 text-sm text-center bg-red-50 p-2 rounded border border-red-100">
                    Usuario o contrase√±a incorrectos
                </div>

                <button type="submit"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                    Entrar al Sistema
                </button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden opacity-0 transition-opacity duration-1000">
        <header class="text-white shadow-lg" style="background-color: #2A3A5B;">
            <div class="container mx-auto px-4 py-6">
                <h1 class="text-2xl md:text-3xl font-bold">Dashboard 5S - Sector Bobinado</h1>
                <p class="text-gray-300 text-sm md:text-base mt-1">Gesti√≥n del Cambio y Sostenibilidad (Shitsuke)</p>
            </div>
        </header>

        <nav class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4">
                <div class="flex space-x-8 overflow-x-auto">
                    <button onclick="showTab('dashboard')" id="tab-dashboard"
                        class="py-4 px-2 font-semibold transition-colors tab-active whitespace-nowrap">Dashboard</button>
                    <button onclick="showTab('desvios-detalle')" id="tab-desvios-detalle"
                        class="py-4 px-2 font-semibold transition-colors text-gray-600 hover:text-orange-600 whitespace-nowrap">Desv√≠os
                        Detalle</button>
                    <button onclick="showTab('kaizen-detalle')" id="tab-kaizen-detalle"
                        class="py-4 px-2 font-semibold transition-colors text-gray-600 hover:text-orange-600 whitespace-nowrap">Ideas
                        Kaizen</button>
                    <button onclick="showTab('analytics')" id="tab-analytics"
                        class="py-4 px-2 font-semibold transition-colors text-gray-600 hover:text-orange-600 whitespace-nowrap">An√°lisis
                        por OLA</button>
                    <button onclick="showTab('mapa-planta')" id="tab-mapa-planta"
                        class="py-4 px-2 font-semibold transition-colors text-gray-600 hover:text-orange-600 whitespace-nowrap">
                        Mapa de Planta
                    </button>
                    <button onclick="showTab('data-entry')" id="tab-data-entry"
                        class="py-4 px-2 font-semibold transition-colors text-gray-600 hover:text-orange-600 whitespace-nowrap">Entrada
                        de Datos</button>
                </div>
                <div id="auth-status" class="text-xs text-gray-500 pt-1">Iniciando autenticaci√≥n.</div>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-8">
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="space-y-8">

                <!-- Agrega esto en el dashboard, cerca del t√≠tulo "C√©lula Estandarizada de la Semana"
            <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg shadow-lg p-6 text-center relative">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">üèÜ C√©lula Estandarizada de la Semana</h2>
                <p id="best-cell" class="text-3xl md:text-4xl font-bold text-gray-900">Cargando...</p>
                
                
                <button onclick="toggleScoreInfo()"
                    class="absolute top-4 right-4 text-gray-700 hover:text-gray-900 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>

                <div id="score-info" class="hidden mt-4 p-4 bg-yellow-100 rounded-lg text-left text-sm text-gray-700">
                    <h3 class="font-bold mb-2">üìä Criterios de Evaluaci√≥n:</h3>
                    <ul class="space-y-1">
                        <li>‚Ä¢ <strong>Auditor√≠as SHITSUKE (50%)</strong>: Promedio √∫ltimas 4 auditor√≠as</li>
                        <li>‚Ä¢ <strong>Eficiencia (30%)</strong>: Tiempo promedio de cierre de desv√≠os (24h = 100pts, 72h
                            = 0pts)
                        </li>
                        <li>‚Ä¢ <strong>Participaci√≥n Kaizen (20%)</strong>: Cantidad de ideas de mejora (5+ ideas =
                            100pts)</li>
                    </ul>
                    <p class="mt-2 text-xs text-gray-600">Actualizado autom√°ticamente cada vez que se cargan nuevos
                        datos.</p>
                </div>
            </div> -->


                <section>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Puntaje de Mantenimiento 5S (Shitsuke)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="shitsuke-cards"></div>
                </section>

                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Comparativa BASELINE vs. √öltimo Puntaje</h2>
                    <div class="h-64 md:h-80 chart-container"><canvas id="baseline-chart"></canvas></div>
                </section>

                <section>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Eficiencia y Acci√≥n</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">TMRD (Tiempo Medio de Respuesta)</h3>
                            <p id="tmrd-value" class="text-4xl font-bold text-orange-600">-- h</p>
                            <p class="text-sm text-gray-500 mt-2">Promedio de cierre de desv√≠os</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Ideas Kaizen Activas</h3>
                            <p id="kaizen-count" class="text-4xl font-bold text-green-600">--</p>
                            <p class="text-sm text-gray-500 mt-2">Ideas de mejora abiertas</p>

                            <button onclick="showTab('kaizen-detalle')"
                                class="bg-orange-600 hover:bg-orange-700 text-white font-semibold px-6 py-3 rounded-lg">Ver</button>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Desv√≠os (√öltimo Mes)</h3>
                            <div class="h-40 chart-container"><canvas id="desvios-chart"></canvas></div>
                        </div>
                    </div>
                    <!-- Ranking Table - Despu√©s del cuadro de c√©lula estandarizada -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üèÖ Ranking de C√©lulas</h3>
                        <div id="ranking-table" class="space-y-3">
                            <div class="text-center py-4 text-gray-500">
                                <p>Cargando ranking...</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>


            <!-- DESV√çOS DETALLE -->
            <div id="view-desvios-detalle" class="hidden space-y-8">
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Filtros de Desv√≠os y Kaizen</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">OLA</label>
                            <select id="filter-ola"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                onchange="loadDesviosDetalle()">
                                <option value="">Todas las OLAs</option>
                                <option value="OLA 1">OLA 1</option>
                                <option value="OLA 2">OLA 2</option>
                                <option value="OLA 3">OLA 3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo</label>
                            <select id="filter-tipo"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                onchange="loadDesviosDetalle()">
                                <option value="">Todos</option>
                                <option value="DESVIO">Desv√≠os</option>
                                <option value="KAIZEN">Kaizen</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Estado</label>
                            <select id="filter-estado"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                onchange="loadDesviosDetalle()">
                                <option value="">Todos</option>
                                <option value="ABIERTO">Abiertos</option>
                                <option value="CERRADO">Cerrados</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="loadDesviosDetalle()"
                                class="w-full bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-semibold">Refrescar</button>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Total Registros</h3>
                        <p id="summary-total" class="text-3xl font-bold text-orange-600">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Desv√≠os Abiertos</h3>
                        <p id="summary-abiertos" class="text-3xl font-bold text-red-600">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Desv√≠os Cerrados</h3>
                        <p id="summary-cerrados" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Ideas Kaizen</h3>
                        <p id="summary-kaizen" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                </div>

                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Listado de Registros</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Fecha Creaci√≥n
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">OLA</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tipo</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Descripci√≥n</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tiempo Abierto
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="desvios-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- KAIZEN DETALLE -->
            <div id="view-kaizen-detalle" class="hidden space-y-8">
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Filtros - Ideas Kaizen</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">OLA</label>
                            <select id="filter-kaizen-ola"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                onchange="loadKaizenDetalle()">
                                <option value="">Todas las OLAs</option>
                                <option value="OLA 1">OLA 1</option>
                                <option value="OLA 2">OLA 2</option>
                                <option value="OLA 3">OLA 3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Estado</label>
                            <select id="filter-kaizen-estado"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                onchange="loadKaizenDetalle()">
                                <option value="">Todos</option>
                                <option value="ABIERTO">Abiertas</option>
                                <option value="CERRADO">Cerradas</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="loadKaizenDetalle()"
                                class="w-full font-semibold px-6 py-2 rounded-lg text-white"
                                style="background-color:#fe4a00;">Aplicar Filtros</button>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Total Ideas</h3>
                        <p id="kaizen-summary-total" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Abiertas</h3>
                        <p id="kaizen-summary-abiertos" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Aprobadas</h3>
                        <p id="kaizen-summary-aprobadas" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Rechazadas</h3>
                        <p id="kaizen-summary-rechazadas" class="text-3xl font-bold text-red-600">0</p>
                    </div>
                </div>

                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Listado de Ideas Kaizen</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Fecha Creaci√≥n
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">OLA</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Descripci√≥n</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Resoluci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="kaizen-table-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- MAPA DE PLANTA -->
            <!-- MAPA DE PLANTA -->
            <div id="view-mapa-planta" class="hidden space-y-8">
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold">Mapa de Planta - Sector Bobinado</h2>
                            <p class="text-gray-600">Visualiza ubicaci√≥n de desv√≠os e ideas Kaizen por OLA</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleMapFilters()"
                                class="px-4 py-2 bg-gray-100 rounded-lg">Filtros</button>
                            <button onclick="refreshMapMarkers()"
                                class="px-4 py-2 bg-orange-600 text-white rounded-lg">Actualizar</button>
                        </div>
                    </div>

                    <!-- Filtros del mapa MEJORADOS -->
                    <div id="map-filters" class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Seleccionar OLA</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label
                                    class="flex items-center gap-3 cursor-pointer p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-orange-300 transition-colors">
                                    <input type="radio" name="ola-filter" value="all" checked
                                        onchange="changePlantMap(this.value)"
                                        class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                                    <span class="flex items-center gap-2">
                                        <span class="w-4 h-4 rounded-full bg-gray-400"></span>
                                        <span class="text-sm font-semibold text-gray-700">Todas las OLAs</span>
                                    </span>
                                </label>
                                <label
                                    class="flex items-center gap-3 cursor-pointer p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-blue-300 transition-colors">
                                    <input type="radio" name="ola-filter" value="OLA 1"
                                        onchange="changePlantMap(this.value)"
                                        class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                    <span class="flex items-center gap-2">
                                        <span class="w-4 h-4 rounded-full bg-blue-500"></span>
                                        <span class="text-sm font-semibold text-gray-700">OLA 1</span>
                                    </span>
                                </label>
                                <label
                                    class="flex items-center gap-3 cursor-pointer p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-green-300 transition-colors">
                                    <input type="radio" name="ola-filter" value="OLA 2"
                                        onchange="changePlantMap(this.value)"
                                        class="w-4 h-4 text-green-600 focus:ring-green-500">
                                    <span class="flex items-center gap-2">
                                        <span class="w-4 h-4 rounded-full bg-green-500"></span>
                                        <span class="text-sm font-semibold text-gray-700">OLA 2</span>
                                    </span>
                                </label>
                                <label
                                    class="flex items-center gap-3 cursor-pointer p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-purple-300 transition-colors">
                                    <input type="radio" name="ola-filter" value="OLA 3"
                                        onchange="changePlantMap(this.value)"
                                        class="w-4 h-4 text-purple-600 focus:ring-purple-500">
                                    <span class="flex items-center gap-2">
                                        <span class="w-4 h-4 rounded-full bg-purple-500"></span>
                                        <span class="text-sm font-semibold text-gray-700">OLA 3</span>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Tipos de Registros</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="filter-map-desvio-abierto" checked
                                        onchange="debouncedRefreshMapMarkers()"
                                        class="w-4 h-4 text-red-600 rounded focus:ring-red-500">
                                    <span class="flex items-center gap-2">
                                        <span class="w-4 h-4 rounded-full bg-red-500"></span>
                                        <span class="text-sm font-semibold text-gray-700">Desv√≠os Abiertos</span>
                                    </span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="filter-map-desvio-cerrado" checked
                                        onchange="debouncedRefreshMapMarkers()"
                                        class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                    <span class="flex items-center gap-2">
                                        <span class="w-4 h-4 rounded-full bg-green-500"></span>
                                        <span class="text-sm font-semibold text-gray-700">Desv√≠os Cerrados</span>
                                    </span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="filter-map-kaizen-abierto" checked
                                        onchange="debouncedRefreshMapMarkers()"
                                        class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="flex items-center gap-2">
                                        <span class="w-4 h-4 rounded-full bg-purple-500"></span>
                                        <span class="text-sm font-semibold text-gray-700">Kaizen Abiertas</span>
                                    </span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="filter-map-kaizen-cerrado" checked
                                        onchange="debouncedRefreshMapMarkers()"
                                        class="w-4 h-4 text-purple-300 rounded focus:ring-purple-500">
                                    <span class="flex items-center gap-2">
                                        <span class="w-4 h-4 rounded-full bg-purple-300"></span>
                                        <span class="text-sm font-semibold text-gray-700">Kaizen Cerradas</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Plant Map MEJORADO -->
                    <div class="plant-map-container bg-gray-100 rounded-lg overflow-hidden shadow-inner">
                        <div style="position:relative;">
                            <!-- Imagen principal que cambiar√° seg√∫n la OLA seleccionada -->
                            <img id="plant-map-image" class="plant-map-image" src="./planta-todas.png"
                                alt="Plano de Planta">
                            <div id="map-markers-container"></div>

                            <!-- Leyenda de √°reas -->
                            <div id="map-legend"
                                class="absolute bottom-4 right-4 bg-white bg-opacity-90 p-3 rounded-lg shadow-md">
                                <h4 class="text-sm font-semibold text-gray-800 mb-2">√Åreas de las OLAs</h4>
                                <div class="space-y-1 text-xs">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-blue-500 rounded"></div>
                                        <span class="text-gray-700">OLA 1 - Rack Almacenamiento</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-green-500 rounded"></div>
                                        <span class="text-gray-700">OLA 2 - Sector Verticalizaci√≥n</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-purple-500 rounded"></div>
                                        <span class="text-gray-700">OLA 3 - Almacenamiento varios</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Total</h3>
                        <p id="map-stat-total" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white rounded-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Desv√≠os Abiertos</h3>
                        <p id="map-stat-desvios-abiertos" class="text-3xl font-bold text-red-600">0</p>
                    </div>
                    <div class="bg-white rounded-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Kaizen Activas</h3>
                        <p id="map-stat-kaizen-abiertos" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="bg-white rounded-lg p-6">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Resueltos</h3>
                        <p id="map-stat-cerrados" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS POR OLA -->
            <div id="view-analytics" class="hidden space-y-8">
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">An√°lisis Espec√≠fico por OLA</h2>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="loadOLAAnalytics('OLA 1', this)"
                            class="bg-orange-600 hover:bg-orange-700 text-white font-semibold px-6 py-3 rounded-lg"
                            data-ola="OLA 1">OLA 1 (C√©lula A)</button>
                        <button onclick="loadOLAAnalytics('OLA 2', this)"
                            class="bg-orange-600 hover:bg-orange-700 text-white font-semibold px-6 py-3 rounded-lg"
                            data-ola="OLA 2">OLA 2 (C√©lula B)</button>
                        <button onclick="loadOLAAnalytics('OLA 3', this)"
                            class="bg-orange-600 hover:bg-orange-700 text-white font-semibold px-6 py-3 rounded-lg"
                            data-ola="OLA 3">OLA 3 (C√©lula C)</button>
                    </div>
                </section>

                <div id="ola-analytics-content">
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">Selecciona una OLA para ver el an√°lisis detallado de la tendencia de desv√≠os.
                        </p>
                    </div>
                </div>
            </div>

            <!-- DATA ENTRY -->
            <!-- REEMPLAZA todo el contenido de <div id="view-data-entry" class="hidden space-y-8"> -->

            <div id="view-data-entry" class="hidden space-y-8">
                <!-- Secci√≥n de Registro R√°pido (NUEVO DISE√ëO) -->
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Registro R√°pido</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Tarjeta Desv√≠os -->
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                                    <span class="text-white font-bold">!</span>
                                </div>
                                <h3 class="text-xl font-bold text-orange-800">Nuevo Desv√≠o</h3>
                            </div>
                            <p class="text-orange-700 mb-4">Registra un problema o desviaci√≥n encontrada</p>
                            <button onclick="showQuickForm('DESVIO')"
                                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                                Crear Desv√≠o
                            </button>
                        </div>

                        <!-- Tarjeta Kaizen -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                                    <span class="text-white font-bold">üí°</span>
                                </div>
                                <h3 class="text-xl font-bold text-purple-800">Idea Kaizen</h3>
                            </div>
                            <p class="text-purple-700 mb-4">Sugiere una mejora o innovaci√≥n</p>
                            <button onclick="showQuickForm('KAIZEN')"
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                                Proponer Idea
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Formulario Din√°mico para Desv√≠os/Kaizen (oculto inicialmente) -->
                <!-- Formulario Din√°mico para Desv√≠os/Kaizen (oculto inicialmente) -->
                <section id="quick-form-container" class="bg-white rounded-lg shadow-lg p-6 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="form-title" class="text-2xl font-bold text-gray-800">Registro</h2>
                        <button onclick="hideQuickForm()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12">
                                </path>
                            </svg>
                        </button>
                    </div>

                    <form id="quick-desvio-form" class="space-y-4">
                        <input type="hidden" id="quick-form-tipo" name="tipo">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìç OLA</label>
                                <select name="ola" id="quick-ola" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                    <option value="">Seleccionar OLA</option>
                                    <option value="OLA 1">OLA 1</option>
                                    <option value="OLA 2">OLA 2</option>
                                    <option value="OLA 3">OLA 3</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üìÑ Descripci√≥n</label>
                            <textarea name="descripcion" id="quick-descripcion" rows="3" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                placeholder="Describe brevemente..."></textarea>
                        </div>

                        <!-- NUEVA SECCI√ìN: Solo para Kaizen - Informaci√≥n de Costos -->
                        <div id="kaizen-cost-section"
                            class="hidden space-y-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                            <h3 class="text-lg font-semibold text-purple-800">üí° Informaci√≥n de la Idea</h3>

                            <div>
                                <label class="block text-sm font-semibold text-purple-700 mb-2">
                                    ¬øTu idea necesita comprar algo?
                                </label>
                                <select name="necesita_compra" id="necesita-compra"
                                    onchange="toggleMaterialInfo(this.value)"
                                    class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="no">No, es solo reorganizar/mejorar lo que hay</option>
                                    <option value="si">S√≠, necesitamos comprar materiales</option>
                                </select>
                            </div>

                            <!-- Solo aparece si necesita comprar -->
                            <div id="material-info" class="hidden space-y-3 p-3 bg-purple-100 rounded-lg">
                                <div>
                                    <label class="block text-sm font-semibold text-purple-700 mb-2">
                                        ¬øQu√© materiales necesit√°s?
                                    </label>
                                    <input type="text" name="materiales" id="materiales-input"
                                        class="w-full px-4 py-2 border border-purple-300 rounded-lg"
                                        placeholder="Ej: Estante met√°lico, tornillos, etc.">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-purple-700 mb-2">
                                        ¬øM√°s o menos cu√°nto cre√©s que sale?
                                    </label>
                                    <select name="costo_aproximado" id="costo-aproximado"
                                        class="w-full px-4 py-2 border border-purple-300 rounded-lg">
                                        <option value="poco">Poco (menos de $10.000)</option>
                                        <option value="moderado">Moderado ($10.000 - $50.000)</option>
                                        <option value="importante">Importante (m√°s de $50.000)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-purple-700 mb-2">
                                    ¬øQu√© ganamos con tu idea?
                                </label>
                                <select name="beneficio_principal" id="beneficio-principal"
                                    class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="tiempo">‚è±Ô∏è Ahorro tiempo (voy a trabajar m√°s r√°pido)</option>
                                    <option value="esfuerzo">üí™ Menor esfuerzo f√≠sico</option>
                                    <option value="seguridad">üõ°Ô∏è M√°s seguridad</option>
                                    <option value="calidad">‚≠ê Mejor calidad del trabajo</option>
                                    <option value="orden">üìÅ M√°s orden y organizaci√≥n</option>
                                    <option value="otro">Otro beneficio</option>
                                </select>
                            </div>
                        </div>

                        <!-- Secci√≥n de Fotos para Desv√≠os/Kaizen -->
                        <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                            <label class="block text-sm font-semibold text-green-800 mb-2">
                                üì∏ Agregar Foto del Problema (Opcional)
                            </label>

                            <input type="file" id="foto-input" accept="image/*" capture="environment" class="hidden">

                            <div class="flex gap-2 mb-2">
                                <button type="button" onclick="takePhoto()"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg text-center text-sm">
                                    üì∑ Sacar Foto
                                </button>
                                <button type="button" onclick="chooseFromGallery()"
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg text-center text-sm">
                                    üñºÔ∏è Galer√≠a
                                </button>
                            </div>

                            <!-- Vista previa -->
                            <div id="foto-preview" class="hidden mt-2 text-center">
                                <img id="foto-preview-img" class="max-w-full rounded-lg shadow-md mx-auto max-h-32">
                                <button type="button" onclick="removePhoto()"
                                    class="mt-1 bg-red-600 hover:bg-red-700 text-white text-xs px-2 py-1 rounded">
                                    ‚ùå Eliminar
                                </button>
                            </div>
                        </div>

                        <div class="flex flex-col gap-4 pt-4">
                            <button type="button" onclick="saveWithLocation()"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors text-center">
                                üó∫Ô∏è Seleccionar Ubicaci√≥n y Guardar
                            </button>

                            <button type="button" onclick="hideQuickForm()"
                                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-8 py-3 rounded-lg transition-colors">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </form>
                </section>

                <!-- SECCI√ìN ORIGINAL DE AUDITOR√çAS (igual a tu versi√≥n) -->
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Registro de Auditor√≠a</h2>
                    <form id="audit-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">OLA</label>
                                <select name="ola" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                    <option value="">Seleccionar OLA</option>
                                    <option value="OLA 1">OLA 1</option>
                                    <option value="OLA 2">OLA 2</option>
                                    <option value="OLA 3">OLA 3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">C√©lula Auditora</label>
                                <select name="auditor_celula" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                    <option value="">Seleccionar C√©lula</option>
                                    <option value="C√©lula A">C√©lula A</option>
                                    <option value="C√©lula B">C√©lula B</option>
                                    <option value="C√©lula C">C√©lula C</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Auditor√≠a</label>
                                <select name="tipo" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                    <option value="">Seleccionar Tipo</option>
                                    <option value="BASELINE">BASELINE</option>
                                    <option value="CERTIFICACION">CERTIFICACI√ìN</option>
                                    <option value="SHITSUKE">SHITSUKE (Mantenimiento)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Puntaje (0-100)</label>
                                <input type="number" name="puntaje" min="0" max="100" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full md:w-auto bg-orange-600 hover:bg-orange-700 text-white font-semibold px-8 py-3 rounded-lg">
                            Guardar Auditor√≠a
                        </button>
                    </form>
                </section>

                <!-- Desv√≠os Abiertos -->
                <section class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">‚ö†Ô∏è Desv√≠os Abiertos</h2>
                        <span id="open-desvios-count"
                            class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold">
                            Cargando...
                        </span>
                    </div>
                    <div id="open-desvios" class="space-y-3">
                        <div class="text-center py-8 text-gray-500">
                            <div
                                class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mb-2">
                            </div>
                            <p>Cargando desv√≠os abiertos...</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- MODALS -->
        <div id="desvio-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="modal-backdrop fixed inset-0" onclick="closeDesvioModal()"></div>
            <div class="flex items-center justify-center min-h-screen px-4 py-8">
                <div class="relative bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div
                        class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-lg">
                        <h2 class="text-2xl font-bold text-gray-800">Detalle de Desv√≠o</h2>
                        <button onclick="closeDesvioModal()"
                            class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="px-6 py-6 space-y-6">
                        <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                            <div class="flex items-center gap-3">
                                <span
                                    class="px-3 py-1 rounded-full text-sm font-semibold bg-orange-100 text-orange-800">DESV√çO</span>
                                <span id="desvio-modal-estado-badge"
                                    class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-600">OLA</p>
                                <p id="desvio-modal-ola" class="text-lg font-bold text-gray-800"></p>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-600">Descripci√≥n</p>
                                <p id="desvio-modal-descripcion" class="text-gray-800"></p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-semibold text-gray-600">Fecha Creaci√≥n</p>
                                    <p id="desvio-modal-fecha-creacion" class="text-gray-800"></p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-600">Fecha Cierre</p>
                                    <p id="desvio-modal-fecha-cierre" class="text-gray-800">-</p>
                                </div>
                            </div>
                            <div id="desvio-modal-resolucion-info" class="hidden border-t border-gray-300 pt-3 mt-3">
                                <div class="mb-3">
                                    <p class="text-sm font-semibold text-gray-600">Notas de Cierre</p>
                                    <p id="desvio-modal-resolucion-notas" class="text-gray-800"></p>
                                </div>
                                <div id="desvio-modal-evidencia-container" class="hidden">
                                    <p class="text-sm font-semibold text-gray-600 mb-2">Evidencia</p>
                                    <div id="desvio-modal-evidencia-content"></div>
                                </div>
                            </div>
                        </div>

                        <div id="desvio-resolution-form-container" class="hidden">
                            <div class="border-t border-gray-200 pt-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Cerrar Desv√≠o</h3>
                                <form id="desvio-resolution-form" class="space-y-4">
                                    <input type="hidden" id="desvio-resolution-item-id" />
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Notas /
                                            Comentarios</label>
                                        <textarea id="desvio-resolution-notes" rows="4" required
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                            placeholder="Describe las acciones tomadas para corregir el desv√≠o..."></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button type="submit"
                                            class="flex-1 font-semibold px-6 py-3 rounded-lg text-white"
                                            style="background-color:#fe4a00;">Cerrar Desv√≠o</button>
                                        <button type="button" onclick="closeDesvioModal()"
                                            class="px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700">Cancelar</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div id="kaizen-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="modal-backdrop fixed inset-0" onclick="closeKaizenModal()"></div>
            <div class="flex items-center justify-center min-h-screen px-4 py-8">
                <div class="relative bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div
                        class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-lg">
                        <h2 class="text-2xl font-bold text-gray-800">Detalle de Idea Kaizen</h2>
                        <button onclick="closeKaizenModal()"
                            class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <div class="px-6 py-6 space-y-6">
                        <div class="bg-gray-50 rounded-lg p-4 space-y-4">
                            <div class="flex items-center gap-3">
                                <span
                                    class="px-3 py-1 rounded-full text-sm font-semibold bg-purple-100 text-purple-800">KAIZEN</span>
                                <span id="kaizen-modal-estado-badge"
                                    class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-semibold text-gray-600">OLA</p>
                                    <p id="kaizen-modal-ola" class="text-lg font-bold text-gray-800"></p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-600">Fecha Creaci√≥n</p>
                                    <p id="kaizen-modal-fecha-creacion" class="text-gray-800"></p>
                                </div>
                            </div>

                            <div>
                                <p class="text-sm font-semibold text-gray-600">Descripci√≥n de la Idea</p>
                                <p id="kaizen-modal-descripcion"
                                    class="text-gray-800 text-lg bg-white p-3 rounded border">
                                </p>
                            </div>

                            <!-- NUEVA SECCI√ìN: Informaci√≥n de Costos y Beneficios -->
                            <div id="kaizen-info-adicional" class="hidden space-y-4 border-t pt-4 mt-4">
                                <h4 class="text-lg font-semibold text-purple-800">üìä Informaci√≥n de la Idea</h4>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-600">¬øNecesita Compra?</p>
                                        <p id="kaizen-modal-necesita-compra" class="text-gray-800 font-semibold"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-600">Beneficio Principal</p>
                                        <p id="kaizen-modal-beneficio" class="text-gray-800"></p>
                                    </div>
                                </div>

                                <div id="kaizen-materiales-info" class="hidden bg-purple-50 p-3 rounded-lg">
                                    <p class="text-sm font-semibold text-purple-700 mb-2">üì¶ Materiales Necesarios</p>
                                    <p id="kaizen-modal-materiales" class="text-gray-800 mb-2"></p>
                                    <p class="text-sm font-semibold text-purple-700">üí∞ Costo Aproximado</p>
                                    <p id="kaizen-modal-costo" class="text-gray-800 font-semibold"></p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-semibold text-gray-600">Fecha Resoluci√≥n</p>
                                    <p id="kaizen-modal-fecha-cierre" class="text-gray-800">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Foto si existe -->
                        <div id="kaizen-foto-container" class="hidden">
                            <!-- Se llena din√°micamente -->
                        </div>

                        <div id="kaizen-modal-resolucion-info" class="hidden border-t border-gray-300 pt-4 mt-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">üìã Resoluci√≥n</h4>
                            <div class="mb-3">
                                <p class="text-sm font-semibold text-gray-600">Estado de Resoluci√≥n</p>
                                <p id="kaizen-modal-resolucion-estado" class="text-gray-800 font-semibold"></p>
                            </div>
                            <div class="mb-3">
                                <p class="text-sm font-semibold text-gray-600">Notas de Resoluci√≥n</p>
                                <p id="kaizen-modal-resolucion-notas" class="text-gray-800 bg-white p-3 rounded border">
                                </p>
                            </div>
                            <div id="kaizen-modal-evidencia-container" class="hidden">
                                <p class="text-sm font-semibold text-gray-600 mb-2">Evidencia</p>
                                <div id="kaizen-modal-evidencia-content"></div>
                            </div>
                        </div>

                        <div id="kaizen-resolution-form-container" class="hidden">
                            <div class="border-t border-gray-200 pt-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Resolver Idea Kaizen</h3>
                                <form id="kaizen-resolution-form" class="space-y-4">
                                    <input type="hidden" id="kaizen-resolution-item-id" />
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Estado de
                                            Resoluci√≥n</label>
                                        <select id="kaizen-resolution-status"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                            <option value="APROBADO">‚úì Aprobado - Implementado</option>
                                            <option value="RECHAZADO">‚úó Rechazado - No Viable</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Notas /
                                            Comentarios</label>
                                        <textarea id="kaizen-resolution-notes" rows="4" required
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                            placeholder="Describe la implementaci√≥n, beneficios obtenidos, o raz√≥n del rechazo..."></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button type="submit"
                                            class="flex-1 font-semibold px-6 py-3 rounded-lg text-white"
                                            style="background-color:#fe4a00;">Guardar Resoluci√≥n</button>
                                        <button type="button" onclick="closeKaizenModal()"
                                            class="px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700">Cancelar</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        ```html
    </div> ```
    <div id="toast"
        class="hidden fixed bottom-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg transition-opacity z-50">
        <p id="toast-message"></p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const sesionGuardada = localStorage.getItem("app_5s_login");

            if (sesionGuardada === "true") {
                // Si ya entr√≥, mostramos la app directo
                mostrarApp();
            }
            // Si no, se queda viendo el login por defecto
        });

        // 2. Funci√≥n para validar usuario y contrase√±a
        function doLogin() {
            const user = document.getElementById("username").value;
            const pass = document.getElementById("password").value;
            const errorMsg = document.getElementById("login-error");

            // AQU√ç EST√ÅN LAS CREDENCIALES: admin / admin
            if (user === "admin" && pass === "admin") {
                // Guardamos que ya entr√≥ en la memoria del navegador
                localStorage.setItem("app_5s_login", "true");
                errorMsg.classList.add("hidden");
                mostrarApp();
            } else {
                // Error
                errorMsg.classList.remove("hidden");
                // Efecto de error visual
                document.getElementById("password").value = "";
                document.getElementById("username").focus();
            }
        }

        // 3. Funci√≥n para mostrar la app y ocultar el login con animaci√≥n
        function mostrarApp() {
            const loginScreen = document.getElementById("login-screen");
            const appContainer = document.getElementById("app-container");

            // Desvanecer login
            loginScreen.style.opacity = "0";
            setTimeout(() => {
                loginScreen.classList.add("hidden");

                // Mostrar app
                appContainer.classList.remove("hidden");
                // Peque√±o delay para que la transici√≥n de opacidad funcione
                setTimeout(() => {
                    appContainer.classList.remove("opacity-0");
                }, 50);

                // INICIAMOS FIREBASE AQU√ç
                initFirebase();
            }, 500);
        }

        // 4. Funci√≥n para Cerrar Sesi√≥n (Opcional, puedes llamarla desde la consola o un bot√≥n)
        function logout() {
            if (confirm("¬øCerrar sesi√≥n?")) {
                localStorage.removeItem("app_5s_login");
                window.location.reload();
            }
        }
        let currentPhotoFile = null;
        let pendingFormData = null;
        let currentFotoDespuesFile = null;
        let mapSelectorMode = false;
        let selectedItemForMap = null;
        let baselineChart = null;
        let desviosChart = null;
        let olaTimelineChart = null;
        let olaDesviosTipoChart = null;
        let olaDesviosEstadoChart = null;
        let refreshTimeout = null;

        // Cache simple para evitar llamadas repetidas
        const dataCache = {};

        // ========== VARIABLES PARA GESTI√ìN DE UBICACI√ìN ==========
        let selectedCoordinates = { x: null, y: null };
        let currentFormData = null;
        // AGREGAR: Al inicio del script
        const CONFIG = {
            PESOS: {
                AUDITORIA: 0.5,
                EFICIENCIA: 0.3,
                KAIZEN: 0.2
            },
            LIMITES: {
                AUDITORIAS: 4,
                HORAS_IDEAL: 24,
                HORAS_MAX: 72,
                KAIZEN_MAX: 5
            },
            COLORES: {
                EXCELENTE: '#22c55e',
                BUENO: '#eab308',
                REGULAR: '#ef4444'
            }

        };
        // AGREGAR: Utilidades comunes
        const utils = {
            formatHours: (hours) => {
                if (hours < 24) return `${Math.round(hours)}h`;
                return `${Math.round(hours / 24)}d`;
            },

            getStatusColor: (score) => {
                if (score >= 90) return CONFIG.COLORES.EXCELENTE;
                if (score >= 75) return CONFIG.COLORES.BUENO;
                return CONFIG.COLORES.REGULAR;
            },

            sanitizeText: (text) => {
                return text.replace(/[<>]/g, '').substring(0, 500);
            }
        };
        // ---------- FIREBASE CONFIG (basado en indexMIO) ----------
        const firebaseConfig = {
            apiKey: "AIzaSyBAMCaKwSIY2-PJf1MeXjV-IxQtZ8MNazI",
            authDomain: "proyecto-lean-tte.firebaseapp.com",
            projectId: "proyecto-lean-tte",
            storageBucket: "proyecto-lean-tte.appspot.com",
            messagingSenderId: "262130237517",
            appId: "1:262130237517:web:7ff6e88cce794b6b5b9c04"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const staticAppId = firebaseConfig.projectId;

        // Public shared user id
        let currentUserId = "PUBLIC_5S_SHARED_USER";

        // Helpers
        const toDate = (ts) => ts ? ts.toDate() : new Date();
        const diffInHours = (d1, d2) => Math.abs(d1.getTime() - d2.getTime()) / (1000 * 60 * 60);

        // MODIFICADO: Usar estructura de indexMIO
        function getCollectionRef(collectionName) {
            const path = `artifacts/proyecto-lean-tte/users/${currentUserId}/${collectionName}`;
            console.log("Using correct Firebase path:", path);
            return db.collection(path);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            toast.classList.add(type === 'success' ? 'bg-green-600' : 'bg-red-600');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // ---------- INIT ----------
        function initFirebase() {
            const authStatusElement = document.getElementById('auth-status');
            authStatusElement.innerHTML = `ID: ${currentUserId.substring(0, 8)}... | <span class="font-bold text-green-600">CONECTADO (P√öBLICO)</span>`;
            loadDashboard();
            loadOpenDesvios();
        }

        // ---------- Tabs ----------
        function showTab(tabName) {
            const tabs = ['dashboard', 'desvios-detalle', 'kaizen-detalle', 'analytics', 'mapa-planta', 'data-entry'];
            tabs.forEach(tab => {
                const viewElement = document.getElementById(`view-${tab}`);
                const tabElement = document.getElementById(`tab-${tab}`);
                if (viewElement && tabElement) {
                    viewElement.classList.toggle('hidden', tab !== tabName);
                    tabElement.classList.toggle('tab-active', tab === tabName);
                    tabElement.classList.toggle('text-gray-600', tab !== tabName);
                    tabElement.classList.toggle('hover:text-orange-600', tab !== tabName);
                    tabElement.classList.toggle('text-orange-600', tab === tabName);
                }
            });
            if (tabName === 'dashboard') loadDashboard();
            else if (tabName === 'data-entry') loadOpenDesvios();
            else if (tabName === 'desvios-detalle') loadDesviosDetalle();
            else if (tabName === 'kaizen-detalle') loadKaizenDetalle();
            else if (tabName === 'analytics') loadOLAAnalytics('OLA 1');
            else if (tabName === 'mapa-planta') loadPlantMap();
        }

        // ---------- DASHBOARD (charts vars) ----------

        async function loadDashboard() {
            if (!currentUserId) return;
            await Promise.all([loadShitsukeCards(), loadBaselineChart(), loadEfficiencyKPIs(), loadBestCell()]);
        }

        async function loadShitsukeCards() {
            const container = document.getElementById('shitsuke-cards');
            const olas = ['OLA 1', 'OLA 2', 'OLA 3'];

            try {
                const cards = await Promise.all(olas.map(async (ola) => {
                    // Usar cache para auditor√≠as
                    const cacheKey = `auditorias_${ola.replace(' ', '_')}_shitsuke`;
                    const audSnap = await getCachedData(
                        getCollectionRef('auditorias')
                            .where('ola', '==', ola)
                            .where('tipo', '==', 'SHITSUKE')
                            .orderBy('fecha', 'desc')
                            .limit(4),
                        cacheKey,
                        60000 // 1 minuto de cache
                    );

                    const scores = audSnap.docs.map(d => d.data().puntaje).filter(v => typeof v === 'number');
                    const avgScore = scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : 0;

                    let colorClass = 'border-red-500 text-red-500';
                    if (avgScore >= 90) colorClass = 'border-green-500 text-green-500';
                    else if (avgScore >= 75) colorClass = 'border-yellow-500 text-yellow-500';

                    return `<div class="bg-white rounded-lg shadow-lg p-6 border-t-4 ${colorClass}">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${ola}</h3>
                        <p class="text-5xl font-bold ${colorClass.replace('border-', 'text-')} mb-2">${avgScore}%</p>
                        <p class="text-sm text-gray-600">Promedio √∫ltimas ${scores.length} auditor√≠as</p>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-xs text-gray-500">${scores.length > 0 ? 'Actualizado ahora' : 'Sin datos'}</p>
                        </div>
                    </div>`;
                }));
                container.innerHTML = cards.join('');
            } catch (error) {
                console.error('Error loading shitsuke cards:', error);
                container.innerHTML = '<div class="col-span-3 text-center text-red-500">Error cargando datos</div>';
            }
        }

        async function loadBaselineChart() {
            const olas = ['OLA 1', 'OLA 2', 'OLA 3'];
            const baselineScores = [];
            const anteultimaScores = [];
            const ultimaScores = [];

            const kpisRef = getCollectionRef('kpis_generales');
            const auditoriasRef = getCollectionRef('auditorias');
            if (!kpisRef || !auditoriasRef) return;

            for (const ola of olas) {
                // baseline
                const baselineSnap = await kpisRef.where('ola', '==', ola).limit(1).get();
                if (!baselineSnap.empty) {
                    baselineScores.push(baselineSnap.docs[0].data().baseline_score || 0);
                } else {
                    baselineScores.push(0);
                }

                // auditor√≠as SHITSUKE (√∫ltimas dos)
                const audSnap = await auditoriasRef
                    .where('ola', '==', ola)
                    .where('tipo', '==', 'SHITSUKE')
                    .orderBy('fecha', 'desc')
                    .limit(2)
                    .get();

                const scores = audSnap.docs.map((d) => d.data().puntaje);
                ultimaScores.push(scores[0] || 0);
                anteultimaScores.push(scores[1] || 0);
            }

            const ctxEl = document.getElementById('baseline-chart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');

            if (baselineChart) baselineChart.destroy();

            baselineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: olas,
                    datasets: [
                        {
                            label: 'BASELINE',
                            data: baselineScores,
                            backgroundColor: 'rgba(59,130,246,0.7)',
                            borderColor: 'rgb(59,130,246)',
                            borderWidth: 2,
                        },
                        {
                            label: 'Ante√∫ltima Auditor√≠a',
                            data: anteultimaScores,
                            backgroundColor: 'rgba(234,179,8,0.7)',
                            borderColor: 'rgb(234,179,8)',
                            borderWidth: 2,
                        },
                        {
                            label: '√öltima Auditor√≠a',
                            data: ultimaScores,
                            backgroundColor: 'rgba(16,185,129,0.7)',
                            borderColor: 'rgb(16,185,129)',
                            borderWidth: 2,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { position: 'bottom' } },
                },
            });
        }

        async function loadEfficiencyKPIs() {
            try {
                // Cache para desv√≠os cerrados
                const desviosCacheKey = 'desvios_cerrados_tmrd';
                const closedSnap = await getCachedData(
                    getCollectionRef('desvios_kaizen')
                        .where('tipo', '==', 'DESVIO')
                        .where('estado', '==', 'CERRADO'),
                    desviosCacheKey,
                    120000 // 2 minutos de cache
                );

                let totalHours = 0, count = 0;
                closedSnap.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.fecha_cierre && data.fecha_creacion) {
                        totalHours += diffInHours(toDate(data.fecha_cierre), toDate(data.fecha_creacion));
                        count++;
                    }
                });

                const tmrd = count > 0 ? (totalHours / count).toFixed(1) : 0;
                document.getElementById('tmrd-value').textContent = `${tmrd} h`;

                // Cache para kaizen activos
                const kaizenCacheKey = 'kaizen_activos_count';
                const kaizenSnap = await getCachedData(
                    getCollectionRef('desvios_kaizen')
                        .where('tipo', '==', 'KAIZEN')
                        .where('estado', '==', 'ABIERTO'),
                    kaizenCacheKey,
                    120000
                );

                document.getElementById('kaizen-count').textContent = kaizenSnap.size;

                // Gr√°fico de desv√≠os
                const allDesviosCacheKey = 'desvios_all_chart';
                const allDesvios = await getCachedData(
                    getCollectionRef('desvios_kaizen').where('tipo', '==', 'DESVIO'),
                    allDesviosCacheKey,
                    120000
                );

                let abiertos = 0, cerrados = 0;
                allDesvios.docs.forEach(d => {
                    if (d.data().estado === 'ABIERTO') abiertos++;
                    else cerrados++;
                });

                const desviosCtxEl = document.getElementById('desvios-chart');
                if (!desviosCtxEl) return;
                const desvCtx = desviosCtxEl.getContext('2d');

                if (desviosChart) desviosChart.destroy();
                desviosChart = new Chart(desvCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Abiertos', 'Cerrados'],
                        datasets: [{
                            data: [abiertos, cerrados],
                            backgroundColor: ['rgba(239,68,68,0.7)', 'rgba(34,197,94,0.7)'],
                            borderColor: ['rgb(239,68,68)', 'rgb(34,197,94)'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.label}: ${context.raw} desv√≠os`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading efficiency KPIs:', error);
                showToast('Error cargando m√©tricas de eficiencia', 'error');
            }
        }

        async function loadBestCell() {
            const cells = ['C√©lula A', 'C√©lula B', 'C√©lula C'];
            let bestCell = '';
            let bestScore = 0;

            const auditoriasRef = getCollectionRef('auditorias');
            const desviosRef = getCollectionRef('desvios_kaizen');

            if (!auditoriasRef || !desviosRef) {
                document.getElementById('best-cell').textContent = 'Error de conexi√≥n';
                return;
            }

            try {
                const cellScores = await Promise.all(cells.map(async (cell) => {
                    // Mapeo de c√©lula a OLA
                    const olaMap = {
                        'C√©lula A': 'OLA 1',
                        'C√©lula B': 'OLA 2',
                        'C√©lula C': 'OLA 3'
                    };
                    const ola = olaMap[cell];

                    // 1. Puntaje de auditor√≠as SHITSUKE (50% peso)
                    const audSnap = await auditoriasRef
                        .where('auditor_celula', '==', cell)
                        .where('tipo', '==', 'SHITSUKE')
                        .orderBy('fecha', 'desc')
                        .limit(4)
                        .get();

                    const auditScores = audSnap.docs.map(d => d.data().puntaje).filter(v => typeof v === 'number');
                    const auditAvg = auditScores.length ? auditScores.reduce((a, b) => a + b, 0) / auditScores.length : 0;

                    // 2. Eficiencia en cierre de desv√≠os (30% peso)
                    const desviosSnap = await desviosRef
                        .where('ola', '==', ola)
                        .where('tipo', '==', 'DESVIO')
                        .where('estado', '==', 'CERRADO')
                        .get();

                    let efficiencyScore = 100;
                    if (desviosSnap.size > 0) {
                        let totalHours = 0;
                        let count = 0;

                        desviosSnap.docs.forEach(doc => {
                            const data = doc.data();
                            if (data.fecha_cierre && data.fecha_creacion) {
                                totalHours += diffInHours(toDate(data.fecha_cierre), toDate(data.fecha_creacion));
                                count++;
                            }
                        });

                        if (count > 0) {
                            const avgHours = totalHours / count;
                            // Menos de 24h = 100 puntos, m√°s de 72h = 0 puntos
                            efficiencyScore = Math.max(0, 100 - ((avgHours - 24) / 48 * 100));
                        }
                    }

                    // 3. Participaci√≥n en Kaizen (20% peso)
                    const kaizenSnap = await desviosRef
                        .where('ola', '==', ola)
                        .where('tipo', '==', 'KAIZEN')
                        .get();

                    // 0 ideas = 0 puntos, 5+ ideas = 100 puntos
                    const kaizenCount = kaizenSnap.size;
                    const kaizenScore = Math.min(100, kaizenCount * 20);

                    // Puntuaci√≥n final ponderada
                    const finalScore = (auditAvg * 0.5) + (efficiencyScore * 0.3) + (kaizenScore * 0.2);

                    console.log(`${cell} - Auditor√≠a: ${Math.round(auditAvg)}, Eficiencia: ${Math.round(efficiencyScore)}, Kaizen: ${Math.round(kaizenScore)}, Total: ${Math.round(finalScore)}`);

                    return {
                        cell,
                        score: finalScore,
                        details: {
                            audit: Math.round(auditAvg),
                            efficiency: Math.round(efficiencyScore),
                            kaizen: Math.round(kaizenScore)
                        }
                    };
                }));

                // Encontrar la mejor c√©lula
                cellScores.forEach(({ cell, score, details }) => {
                    if (score > bestScore) {
                        bestScore = score;
                        bestCell = cell;
                    }
                });

                let displayText = 'Sin datos suficientes';
                if (bestCell && bestScore > 0) {
                    const details = cellScores.find(c => c.cell === bestCell).details;
                    displayText = `${bestCell}  ${Math.round(bestScore)} pts`;

                    // Opcional: Mostrar detalles en tooltip o console
                    console.log(`üèÜ ${bestCell} ganadora:`);
                    console.log(`   üìä Auditor√≠a: ${details.audit} pts`);
                    console.log(`   ‚ö° Eficiencia: ${details.efficiency} pts`);
                    console.log(`   üí° Kaizen: ${details.kaizen} pts`);
                }

                document.getElementById('best-cell').textContent = displayText;

            } catch (error) {
                console.error('Error calculando mejor c√©lula:', error);
                document.getElementById('best-cell').textContent = 'Error en c√°lculo';
            }
            // Al final de loadBestCell, agrega:
            loadRankingTable();


        }

        // ---------- DATA ENTRY (forms) ----------
        window.handleAuditSubmit = async function (e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            try {
                await getCollectionRef('auditorias').add({
                    ola: data.ola,
                    auditor_celula: data.auditor_celula,
                    tipo: data.tipo,
                    puntaje: parseInt(data.puntaje),
                    fecha: firebase.firestore.Timestamp.now()
                });
                showToast(`Auditor√≠a de ${data.ola} (${data.tipo}) guardada!`);
                form.reset();
                loadDashboard();
            } catch (err) {
                console.error(err);
                showToast("Error al guardar auditor√≠a", 'error');
            }
        };

        // MODIFICADO: Manejo mejorado del formulario con mapa
        window.handleDesvioSubmit = async function (e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const btnSelectMap = document.getElementById('btn-select-map');

            // Disable map button during submission
            btnSelectMap.disabled = true;
            btnSelectMap.classList.add('bg-gray-400');
            btnSelectMap.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            btnSelectMap.dataset.itemId = '';

            try {
                const desviosRef = getCollectionRef('desvios_kaizen');
                if (!desviosRef) throw new Error("No se pudo obtener la referencia de la colecci√≥n.");

                const docRef = await desviosRef.add({
                    tipo: data.tipo,
                    ola: data.ola,
                    descripcion: data.descripcion,
                    estado: 'ABIERTO',
                    fecha_creacion: firebase.firestore.Timestamp.now(),
                    fecha_cierre: null,
                    resolucion_notas: null,
                    resolucion_estado: null,
                    coordenada_x: null,
                    coordenada_y: null
                });

                showToast(`Registro de ${data.tipo} para ${data.ola} creado!`);
                form.reset();

                // Re-enable map button with the new document ID
                btnSelectMap.dataset.itemId = docRef.id;
                btnSelectMap.disabled = false;
                btnSelectMap.classList.remove('bg-gray-400');
                btnSelectMap.classList.add('bg-orange-500', 'hover:bg-orange-600');

                loadOpenDesvios();
                loadEfficiencyKPIs();

            } catch (error) {
                console.error("Error al guardar desv√≠o/kaizen:", error);
                showToast("Error al guardar registro", 'error');
                btnSelectMap.disabled = false;
                btnSelectMap.classList.remove('bg-gray-400');
                btnSelectMap.classList.add('bg-orange-500', 'hover:bg-orange-600');
            }
        };

        // Bind forms
        window.addEventListener('load', () => {
            const aForm = document.getElementById('audit-form');
            window.addEventListener('load', () => {
                // ... c√≥digo existente ...
                const aForm = document.getElementById('audit-form');
                if (aForm) aForm.addEventListener('submit', handleAuditSubmit);

                // Agregar listener para el nuevo formulario r√°pido
                const quickForm = document.getElementById('quick-desvio-form');
                if (quickForm) {
                    quickForm.addEventListener('submit', handleQuickFormSubmit);
                }

                // Configurar el bot√≥n de mapa del formulario r√°pido
                setupQuickMapSelection();

                // ... resto del c√≥digo ...
            });
            if (aForm) aForm.addEventListener('submit', handleAuditSubmit);

            const dForm = document.getElementById('desvio-form');
            if (dForm) dForm.addEventListener('submit', handleDesvioSubmit);

            const dResForm = document.getElementById('desvio-resolution-form');
            if (dResForm) dResForm.addEventListener('submit', submitDesvioResolution);

            const kResForm = document.getElementById('kaizen-resolution-form');
            if (kResForm) kResForm.addEventListener('submit', submitKaizenResolution);

            // Add listener for the map selection button
            const btnSelectMap = document.getElementById('btn-select-map');
            if (btnSelectMap) {
                btnSelectMap.addEventListener('click', function () {
                    const itemId = this.dataset.itemId;
                    if (!itemId) {
                        showToast('Primero guarda el registro antes de seleccionar ubicaci√≥n.', 'error');
                        return;
                    }
                    showTab('mapa-planta');
                    setTimeout(() => enableMapCoordinateSelection(itemId), 100);
                });
            }
        });

        // ---------- OPEN / CLOSE DESV√çOS LIST ----------
        window.loadOpenDesvios = async function () {
            const container = document.getElementById('open-desvios');
            const desviosRef = getCollectionRef('desvios_kaizen');
            if (!desviosRef) return;
            try {
                const snapshot = await desviosRef.where('tipo', '==', 'DESVIO').where('estado', '==', 'ABIERTO').get();
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">No hay desv√≠os abiertos</p>';
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const id = doc.id;
                    const date = d.fecha_creacion ? toDate(d.fecha_creacion).toLocaleDateString() : 'N/A';
                    return `<div class="flex flex-col md:flex-row md:items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex-1 mb-3 md:mb-0"><p class="font-semibold text-gray-800">${d.ola} - ${d.descripcion}</p><p class="text-sm text-gray-500">Creado: ${date}</p></div>
                        <div class="flex gap-2">
                            <button onclick="openDesvioModal('${id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Ver</button>
                            <button onclick="closeDesvio('${id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Cerrar</button>
                        </div>
                    </div>`;
                }).join('');
            } catch (err) {
                console.error('Error loading open desvios:', err);
                container.innerHTML = '<p class="text-red-500">Error al cargar desv√≠os abiertos.</p>';
            }
        };

        async function closeDesvio(desvioId) {
            try {
                await getCollectionRef('desvios_kaizen').doc(desvioId).update({
                    fecha_cierre: firebase.firestore.Timestamp.now(),
                    estado: 'CERRADO'
                });
                showToast('Desv√≠o cerrado exitosamente');
                loadOpenDesvios();
                loadDesviosDetalle();
                loadEfficiencyKPIs();
            } catch (err) {
                console.error(err);
                showToast('Error al cerrar desv√≠o', 'error');
            }
        }

        // ---------- DESV√çOS DETALLE ----------
        async function loadDesviosDetalle() {
            const tableBody = document.getElementById('desvios-table-body');
            const desviosRef = getCollectionRef('desvios_kaizen');
            if (!desviosRef) return;

            const filterOla = document.getElementById('filter-ola').value;
            const filterEstado = document.getElementById('filter-estado').value;

            let queryRef = desviosRef.where('tipo', '==', 'DESVIO');
            if (filterOla) queryRef = queryRef.where('ola', '==', filterOla);
            if (filterEstado) queryRef = queryRef.where('estado', '==', filterEstado);

            const snapshot = await queryRef.orderBy('fecha_creacion', 'desc').get();

            // resumen
            let totalRegistros = snapshot.size;
            let abiertos = 0;
            let cerrados = 0;
            snapshot.docs.forEach((doc) => {
                const d = doc.data();
                if (d.estado === 'ABIERTO') abiertos++;
                else if (d.estado === 'CERRADO') cerrados++;
            });

            document.getElementById('summary-total').textContent = totalRegistros;
            document.getElementById('summary-abiertos').textContent = abiertos;
            document.getElementById('summary-cerrados').textContent = cerrados;
            document.getElementById('summary-kaizen').textContent = 0;

            if (snapshot.empty) {
                tableBody.innerHTML =
                    '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No se encontraron desv√≠os</td></tr>';
                return;
            }

            tableBody.innerHTML = snapshot.docs
                .map((doc) => {
                    const data = doc.data();
                    const fechaCreacion = toDate(data.fecha_creacion);
                    const fechaCierre = data.fecha_cierre ? toDate(data.fecha_cierre) : null;
                    const totalHoursOpen = diffInHours(fechaCierre || new Date(), fechaCreacion);
                    const diferenciaTiempo =
                        data.estado === 'CERRADO'
                            ? totalHoursOpen > 48
                                ? Math.floor(totalHoursOpen / 24) + ' d√≠as'
                                : totalHoursOpen.toFixed(1) + ' hrs'
                            : 'ABIERTO';
                    const estadoBadge =
                        data.estado === 'ABIERTO'
                            ? `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded mr-2">ABIERTO</span>`
                            : `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">CERRADO</span>`;

                    return `
            <tr class="hover:bg-gray-50 cursor-pointer" onclick='openDesvioModal("${doc.id}")'>
                <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${fechaCreacion.toLocaleDateString()}</td>
                <td class="px-4 py-3 text-sm font-semibold text-gray-800">${data.ola}</td>
                <td class="px-4 py-3 text-sm text-orange-700">Desv√≠o</td>
                <td class="px-4 py-3 text-sm text-gray-700">${data.descripcion}</td>
                <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${diferenciaTiempo}</td>
            </tr>`;
                })
                .join('');
        }

        // ---------- KAIZEN detalle ----------
        window.loadKaizenDetalle = async function () {
            const tableBody = document.getElementById('kaizen-table-body');
            const desviosRef = getCollectionRef('desvios_kaizen');
            if (!desviosRef) return;
            const filterOla = document.getElementById('filter-kaizen-ola').value;
            const filterEstado = document.getElementById('filter-kaizen-estado').value;
            let q = desviosRef.where('tipo', '==', 'KAIZEN');
            if (filterOla) q = q.where('ola', '==', filterOla);
            if (filterEstado) q = q.where('estado', '==', filterEstado);
            const snap = await q.orderBy('fecha_creacion', 'desc').get();
            // summary
            const total = snap.size;
            const abiertos = snap.docs.filter(d => d.data().estado === 'ABIERTO').length;
            const aprobadas = snap.docs.filter(d => d.data().resolucion_estado === 'APROBADO').length;
            const rechazadas = snap.docs.filter(d => d.data().resolucion_estado === 'RECHAZADO').length;
            document.getElementById('kaizen-summary-total').textContent = total;
            document.getElementById('kaizen-summary-abiertos').textContent = abiertos;
            document.getElementById('kaizen-summary-aprobadas').textContent = aprobadas;
            document.getElementById('kaizen-summary-rechazadas').textContent = rechazadas;
            if (snap.empty) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No se encontraron ideas</td></tr>';
                return;
            }
            tableBody.innerHTML = snap.docs.map(doc => {
                const d = doc.data();
                const fecha = toDate(d.fecha_creacion).toLocaleDateString();
                return `<tr onclick="openKaizenModal('${doc.id}')" class="hover:bg-gray-50 cursor-pointer">
                    <td class="px-4 py-3 text-sm text-gray-700">${fecha}</td>
                    <td class="px-4 py-3 text-sm font-semibold text-gray-800">${d.ola}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${d.descripcion}</td>
                    <td class="px-4 py-3 text-sm">${d.estado}</td>
                    <td class="px-4 py-3 text-sm">${d.resolucion_estado || '-'}</td>
                </tr>`;
            }).join('');
        };

        // ---------- MODAL: abrir / cerrar y submit resoluciones ----------
        async function openDesvioModal(id) {
            const docSnap = await getCollectionRef('desvios_kaizen').doc(id).get();
            if (!docSnap.exists) {
                showToast('Registro no encontrado', 'error');
                return;
            }
            const data = docSnap.data();

            // LIMPIAR formulario de resoluci√≥n
            document.getElementById('desvio-resolution-notes').value = '';

            // Llenar datos b√°sicos
            document.getElementById('desvio-modal-ola').textContent = data.ola || '-';
            document.getElementById('desvio-modal-descripcion').textContent = data.descripcion || '-';

            // Estado
            const estadoBadge = document.getElementById('desvio-modal-estado-badge');
            if (data.estado === 'ABIERTO') {
                estadoBadge.textContent = 'ABIERTO';
                estadoBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800';
            } else {
                estadoBadge.textContent = 'CERRADO';
                estadoBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
            }

            // Fechas
            document.getElementById('desvio-modal-fecha-creacion').textContent =
                data.fecha_creacion ? toDate(data.fecha_creacion).toLocaleString() : '-';

            document.getElementById('desvio-modal-fecha-cierre').textContent =
                data.fecha_cierre ? toDate(data.fecha_cierre).toLocaleString() : '-';

            // Mostrar informaci√≥n de resoluci√≥n si est√° cerrado
            const resolucionInfo = document.getElementById('desvio-modal-resolucion-info');
            const resolutionForm = document.getElementById('desvio-resolution-form-container');

            // LIMPIAR elementos de tiempo anteriores
            const elementosTiempo = resolucionInfo.querySelectorAll('.tiempo-resolucion-container');
            elementosTiempo.forEach(el => el.remove());

            if (data.estado === 'CERRADO') {
                resolucionInfo.classList.remove('hidden');
                resolutionForm.classList.add('hidden');

                document.getElementById('desvio-modal-resolucion-notas').textContent =
                    data.resolucion_notas || 'Sin notas';

                // Calcular y mostrar tiempo de resoluci√≥n (SOLO UNA VEZ)
                if (data.fecha_creacion && data.fecha_cierre) {
                    const tiempoAbierto = diffInHours(toDate(data.fecha_cierre), toDate(data.fecha_creacion));
                    const tiempoElement = document.createElement('div');
                    tiempoElement.className = 'tiempo-resolucion-container'; // Clase para identificarlo
                    tiempoElement.innerHTML = `
                <p class="text-sm font-semibold text-gray-600 mt-3">Tiempo de Resoluci√≥n</p>
                <p class="text-green-600 font-bold">${tiempoAbierto < 24 ?
                            tiempoAbierto.toFixed(1) + ' horas' :
                            (tiempoAbierto / 24).toFixed(1) + ' d√≠as'
                        }</p>
            `;
                    resolucionInfo.appendChild(tiempoElement);
                }
            } else {
                resolucionInfo.classList.add('hidden');
                resolutionForm.classList.remove('hidden');
                document.getElementById('desvio-resolution-item-id').value = id;
            }

            // Mostrar foto si existe
            showPhotoInModal('desvio', data);

            // LIMPIAR costos anteriores y mostrar nuevos si existen
            const costosAnteriores = document.querySelectorAll('.costos-container');
            costosAnteriores.forEach(el => el.remove());

            if (data.costos && data.costos.total > 0) {
                const costosContainer = document.createElement('div');
                costosContainer.className = 'costos-container mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200';
                costosContainer.innerHTML = `
            <p class="text-sm font-semibold text-yellow-800 mb-2">üí∞ Costos de Resoluci√≥n</p>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="text-yellow-700">Materiales:</div>
                <div class="text-right">$${data.costos.materiales.toFixed(2)}</div>
                <div class="text-yellow-700">Mano de obra (${data.costos.mano_obra_horas}h):</div>
                <div class="text-right">$${data.costos.mano_obra_costo.toFixed(2)}</div>
                <div class="text-yellow-700">Otros:</div>
                <div class="text-right">$${data.costos.otros.toFixed(2)}</div>
                <div class="text-yellow-700 font-semibold border-t pt-1">Total:</div>
                <div class="text-right font-semibold border-t pt-1">$${data.costos.total.toFixed(2)}</div>
            </div>
        `;
                const descripcionElement = document.getElementById('desvio-modal-descripcion').parentElement;
                descripcionElement.parentNode.insertBefore(costosContainer, descripcionElement.nextSibling);
            }

            document.getElementById('desvio-modal').classList.remove('hidden');
        }



        // MOSTRAR FOTO DEL "ANTES" SI EXISTE


        // AGREGAR tambi√©n esta funci√≥n para ver imagen completa
        function openFullSizeImage(url) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-black bg-opacity-90 flex items-center justify-center p-4';
            modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <img src="${url}" class="max-w-full max-h-full rounded-lg">
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="absolute top-4 right-4 text-white text-2xl bg-red-600 rounded-full w-10 h-10 flex items-center justify-center">
                ‚úï
            </button>
        </div>
    `;
            document.body.appendChild(modal);
        }
        async function submitDesvioResolution(e) {
            e.preventDefault();
            const id = document.getElementById('desvio-resolution-item-id').value;
            const notes = document.getElementById('desvio-resolution-notes').value;

            if (!notes.trim()) {
                showToast('Por favor ingresa notas de resoluci√≥n', 'error');
                return;
            }

            try {
                await getCollectionRef('desvios_kaizen').doc(id).update({
                    estado: 'CERRADO',
                    fecha_cierre: firebase.firestore.Timestamp.now(),
                    resolucion_notas: notes.trim()
                });

                showToast('Desv√≠o cerrado exitosamente');
                closeDesvioModal();
                loadDesviosDetalle();
                loadOpenDesvios();
                loadEfficiencyKPIs();
                loadBestCell();
                loadRankingTable();
            } catch (err) {
                console.error(err);
                showToast('Error al cerrar desv√≠o', 'error');
            }
        }
        function closeDesvioModal() {
            document.getElementById('desvio-resolution-notes').value = '';

            // Limpiar el ID del item
            document.getElementById('desvio-resolution-item-id').value = '';

            // Ocultar modal
            document.getElementById('desvio-modal').classList.add('hidden');            // Limpiar elementos din√°micos
            const resolucionInfo = document.getElementById('desvio-modal-resolucion-info');
            const tiempoElement = resolucionInfo.querySelector('div:last-child');
            if (tiempoElement && tiempoElement.querySelector('text-green-600')) {
                tiempoElement.remove();
            }

            // Ocultar modal
            document.getElementById('desvio-modal').classList.add('hidden');
        }
        async function openKaizenModal(id) {
            console.log('üîç ABRIENDO MODAL KAIZEN ID:', id);

            const docSnap = await getCollectionRef('desvios_kaizen').doc(id).get();
            if (!docSnap.exists) {
                showToast('Registro no encontrado', 'error');
                return;
            }
            const data = docSnap.data();

            // üéØ DEBUG: Ver qu√© datos llegan realmente
            console.log('üì¶ DATOS COMPLETOS DEL REGISTRO:', data);
            console.log('üîé CAMPOS KAIZEN ESPEC√çFICOS:');
            console.log('- necesita_compra:', data.necesita_compra);
            console.log('- beneficio_principal:', data.beneficio_principal);
            console.log('- materiales:', data.materiales);
            console.log('- costo_aproximado:', data.costo_aproximado);

            // Llenar datos b√°sicos
            document.getElementById('kaizen-modal-ola').textContent = data.ola || '-';
            document.getElementById('kaizen-modal-descripcion').textContent = data.descripcion || '-';
            document.getElementById('kaizen-modal-fecha-creacion').textContent = data.fecha_creacion ? toDate(data.fecha_creacion).toLocaleString() : '-';
            document.getElementById('kaizen-modal-fecha-cierre').textContent = data.fecha_cierre ? toDate(data.fecha_cierre).toLocaleString() : '-';

            // Estado
            const estadoBadge = document.getElementById('kaizen-modal-estado-badge');
            if (data.estado === 'ABIERTO') {
                estadoBadge.textContent = 'ABIERTO';
                estadoBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800';
            } else {
                estadoBadge.textContent = 'CERRADO';
                estadoBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
            }

            // üéØ VERIFICAR SI HAY DATOS KAIZEN
            const tieneDatosKaizen = data.necesita_compra || data.beneficio_principal;
            console.log('üìä ¬øTIENE DATOS KAIZEN?', tieneDatosKaizen);

            // MOSTRAR INFORMACI√ìN ADICIONAL DE KAIZEN
            const infoAdicional = document.getElementById('kaizen-info-adicional');
            if (tieneDatosKaizen) {
                console.log('‚úÖ MOSTRANDO SECCI√ìN KAIZEN');
                infoAdicional.classList.remove('hidden');

                // Necesita compra
                const necesitaCompra = document.getElementById('kaizen-modal-necesita-compra');
                if (data.necesita_compra === 'si') {
                    necesitaCompra.textContent = 'S√≠, necesita comprar materiales';
                    necesitaCompra.className = 'text-orange-600 font-semibold';
                } else {
                    necesitaCompra.textContent = 'No, solo reorganizaci√≥n';
                    necesitaCompra.className = 'text-green-600 font-semibold';
                }

                // Beneficio principal
                const beneficioText = {
                    'tiempo': '‚è±Ô∏è Ahorro de tiempo',
                    'esfuerzo': 'üí™ Menor esfuerzo f√≠sico',
                    'seguridad': 'üõ°Ô∏è M√°s seguridad',
                    'calidad': '‚≠ê Mejor calidad',
                    'orden': 'üìÅ M√°s orden y organizaci√≥n',
                    'otro': 'Otro beneficio'
                };
                document.getElementById('kaizen-modal-beneficio').textContent =
                    beneficioText[data.beneficio_principal] || 'No especificado';

                // Mostrar materiales si aplica
                const materialesInfo = document.getElementById('kaizen-materiales-info');
                if (data.necesita_compra === 'si' && data.materiales) {
                    console.log('‚úÖ MOSTRANDO SECCI√ìN MATERIALES');
                    materialesInfo.classList.remove('hidden');
                    document.getElementById('kaizen-modal-materiales').textContent = data.materiales || 'No especificado';

                    // Costo aproximado
                    const costoText = {
                        'poco': 'Poco (menos de $10.000)',
                        'moderado': 'Moderado ($10.000 - $50.000)',
                        'importante': 'Importante (m√°s de $50.000)'
                    };
                    document.getElementById('kaizen-modal-costo').textContent =
                        costoText[data.costo_aproximado] || 'No especificado';
                } else {
                    console.log('‚ùå OCULTANDO SECCI√ìN MATERIALES');
                    materialesInfo.classList.add('hidden');
                }
            } else {
                console.log('‚ùå NO HAY DATOS KAIZEN - OCULTANDO SECCI√ìN');
                infoAdicional.classList.add('hidden');
            }

            // Mostrar informaci√≥n de resoluci√≥n si est√° cerrado
            if (data.estado === 'CERRADO') {
                document.getElementById('kaizen-modal-resolucion-info').classList.remove('hidden');
                document.getElementById('kaizen-resolution-form-container').classList.add('hidden');

                document.getElementById('kaizen-modal-resolucion-estado').textContent = data.resolucion_estado || '';
                document.getElementById('kaizen-modal-resolucion-notas').textContent = data.resolucion_notas || '';
            } else {
                document.getElementById('kaizen-modal-resolucion-info').classList.add('hidden');
                document.getElementById('kaizen-resolution-form-container').classList.remove('hidden');
                document.getElementById('kaizen-resolution-item-id').value = id;
            }

            // Mostrar foto si existe
            showPhotoInModal('kaizen', data);

            document.getElementById('kaizen-modal').classList.remove('hidden');
            console.log('üéâ MODAL KAIZEN ABIERTO');
        }

        function closeKaizenModal() {
            document.getElementById('kaizen-modal').classList.add('hidden');
        }

        async function submitKaizenResolution(e) {
            e.preventDefault();
            const id = document.getElementById('kaizen-resolution-item-id').value;
            const status = document.getElementById('kaizen-resolution-status').value;
            const notes = document.getElementById('kaizen-resolution-notes').value;

            try {
                await getCollectionRef('desvios_kaizen').doc(id).update({
                    estado: 'CERRADO',
                    fecha_cierre: firebase.firestore.Timestamp.now(),
                    resolucion_estado: status,
                    resolucion_notas: notes,
                });
                showToast('Resoluci√≥n guardada correctamente');
                closeKaizenModal();
                loadKaizenDetalle();
                loadDesviosDetalle();
                loadEfficiencyKPIs();
            } catch (err) {
                console.error(err);
                showToast('Error al guardar resoluci√≥n', 'error');
            }
        }

        // ---------- ANALYTICS POR OLA ----------

        async function loadOLAAnalytics(ola, btnEl = null) {
            if (btnEl) {
                document.querySelectorAll('#view-analytics button').forEach(b => {
                    b.classList.remove('ring-4', 'ring-orange-300');
                    b.classList.add('bg-orange-600');
                });
                btnEl.classList.remove('bg-orange-600');
                btnEl.classList.add('bg-orange-700', 'ring-4', 'ring-orange-300');
            }

            try {
                // Cache para datos de la OLA
                const olaCacheKey = `ola_analytics_${ola.replace(' ', '_')}`;
                const snapshot = await getCachedData(
                    getCollectionRef('desvios_kaizen')
                        .where('ola', '==', ola)
                        .orderBy('fecha_creacion', 'desc'),
                    olaCacheKey,
                    90000 // 1.5 minutos de cache
                );

                let totalDesvios = 0, desviosAbiertos = 0, kaizenCount = 0, kaizenAbiertos = 0;
                const monthlyData = {};
                const tipoData = { DESVIO: 0, KAIZEN: 0 };
                const estadoData = { ABIERTO: 0, CERRADO: 0 };
                const ultimos6Meses = [];

                // Calcular √∫ltimos 6 meses para el gr√°fico
                const hoy = new Date();
                for (let i = 5; i >= 0; i--) {
                    const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                    const monthKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    ultimos6Meses.push(monthKey);
                    monthlyData[monthKey] = 0; // Inicializar en 0
                }

                snapshot.docs.forEach(doc => {
                    const d = doc.data();
                    const fecha = toDate(d.fecha_creacion);
                    const monthKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;

                    if (ultimos6Meses.includes(monthKey)) {
                        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                    }

                    tipoData[d.tipo] = (tipoData[d.tipo] || 0) + 1;
                    estadoData[d.estado] = (estadoData[d.estado] || 0) + 1;

                    if (d.tipo === 'DESVIO') {
                        totalDesvios++;
                        if (d.estado === 'ABIERTO') desviosAbiertos++;
                    } else {
                        kaizenCount++;
                        if (d.estado === 'ABIERTO') kaizenAbiertos++;
                    }
                });

                const content = document.getElementById('ola-analytics-content');
                content.innerHTML = `
            <section class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">${ola} - Dashboard de Performance</h2>
                    <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-semibold">
                        ${snapshot.size} registros totales
                    </span>
                </div>

                <!-- Tarjetas de M√©tricas Principales -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <h3 class="text-sm font-semibold text-blue-800">Total Desv√≠os</h3>
                        </div>
                        <p class="text-2xl font-bold text-blue-600">${totalDesvios}</p>
                        <p class="text-xs text-blue-600 mt-1">${desviosAbiertos} abiertos</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                            <h3 class="text-sm font-semibold text-purple-800">Ideas Kaizen</h3>
                        </div>
                        <p class="text-2xl font-bold text-purple-600">${kaizenCount}</p>
                        <p class="text-xs text-purple-600 mt-1">${kaizenAbiertos} por revisar</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <h3 class="text-sm font-semibold text-green-800">Resueltos</h3>
                        </div>
                        <p class="text-2xl font-bold text-green-600">${estadoData.CERRADO || 0}</p>
                        <p class="text-xs text-green-600 mt-1">${Math.round((estadoData.CERRADO / snapshot.size) * 100)}% de total</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <h3 class="text-sm font-semibold text-red-800">Pendientes</h3>
                        </div>
                        <p class="text-2xl font-bold text-red-600">${estadoData.ABIERTO || 0}</p>
                        <p class="text-xs text-red-600 mt-1">Por atender</p>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Tendencia √öltimos 6 Meses</h3>
                        <div class="h-64 chart-container">
                            <canvas id="ola-timeline-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Distribuci√≥n por Tipo</h3>
                        <div class="h-64 chart-container">
                            <canvas id="ola-desvios-tipo-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Detalles de Estado -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç Estado de Desv√≠os</h3>
                        <div class="h-56 chart-container">
                            <canvas id="ola-desvios-estado-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üéØ Resumen de Actividad</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                                <span class="text-sm font-medium text-gray-700">Tasa de Cierre</span>
                                <span class="font-bold ${estadoData.CERRADO > 0 ? 'text-green-600' : 'text-gray-500'}">
                                    ${totalDesvios > 0 ? Math.round((estadoData.CERRADO / totalDesvios) * 100) : 0}%
                                </span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                                <span class="text-sm font-medium text-gray-700">Ratio Kaizen/Desv√≠os</span>
                                <span class="font-bold text-purple-600">
                                    ${totalDesvios > 0 ? (kaizenCount / totalDesvios).toFixed(2) : '0.00'}
                                </span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                                <span class="text-sm font-medium text-gray-700">Actividad Mensual Promedio</span>
                                <span class="font-bold text-blue-600">
                                    ${Math.round(Object.values(monthlyData).reduce((a, b) => a + b, 0) / 6)}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Items Recientes -->
                <div class="bg-gray-50 rounded-lg p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">üìã Actividad Reciente</h3>
                        <span class="text-sm text-gray-500">√öltimos 10 registros</span>
                    </div>
                    <div id="ola-items-list" class="space-y-2"></div>
                </div>
            </section>
        `;

                // === RENDERIZAR GR√ÅFICOS ===

                // 1. Gr√°fico de Timeline
                const ctx1El = document.getElementById('ola-timeline-chart');
                if (ctx1El) {
                    const ctx1 = ctx1El.getContext('2d');
                    if (olaTimelineChart) olaTimelineChart.destroy();

                    const mesesLabels = ultimos6Meses.map(mes => {
                        const [year, month] = mes.split('-');
                        return `${month}/${year.substring(2)}`;
                    });

                    olaTimelineChart = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: mesesLabels,
                            datasets: [{
                                label: 'Registros por Mes',
                                data: ultimos6Meses.map(m => monthlyData[m] || 0),
                                borderColor: 'rgb(254,74,0)',
                                backgroundColor: 'rgba(254,74,0,0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: 'rgb(254,74,0)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 },
                                    title: {
                                        display: true,
                                        text: 'Cantidad de Registros'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Meses'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return `Registros: ${context.raw}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // 2. Gr√°fico de Distribuci√≥n por Tipo
                const ctx2El = document.getElementById('ola-desvios-tipo-chart');
                if (ctx2El) {
                    const ctx2 = ctx2El.getContext('2d');
                    if (olaDesviosTipoChart) olaDesviosTipoChart.destroy();

                    olaDesviosTipoChart = new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: ['Desv√≠os', 'Ideas Kaizen'],
                            datasets: [{
                                data: [tipoData.DESVIO || 0, tipoData.KAIZEN || 0],
                                backgroundColor: [
                                    'rgba(249,115,22,0.8)',
                                    'rgba(168,85,247,0.8)'
                                ],
                                borderColor: [
                                    'rgb(249,115,22)',
                                    'rgb(168,85,247)'
                                ],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const total = tipoData.DESVIO + tipoData.KAIZEN;
                                            const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                            return `${context.label}: ${context.raw} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // 3. Gr√°fico de Estado de Desv√≠os
                const ctx3El = document.getElementById('ola-desvios-estado-chart');
                if (ctx3El) {
                    const ctx3 = ctx3El.getContext('2d');
                    if (olaDesviosEstadoChart) olaDesviosEstadoChart.destroy();

                    olaDesviosEstadoChart = new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: ['Abiertos', 'Cerrados'],
                            datasets: [{
                                label: 'Cantidad',
                                data: [estadoData.ABIERTO || 0, estadoData.CERRADO || 0],
                                backgroundColor: [
                                    'rgba(239,68,68,0.7)',
                                    'rgba(34,197,94,0.7)'
                                ],
                                borderColor: [
                                    'rgb(239,68,68)',
                                    'rgb(34,197,94)'
                                ],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 },
                                    title: {
                                        display: true,
                                        text: 'Cantidad'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Estado'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }

                // 4. Lista de Items Recientes
                const itemsList = document.getElementById('ola-items-list');
                if (snapshot.empty) {
                    itemsList.innerHTML = '<div class="text-center py-8 text-gray-500">No hay registros para esta OLA</div>';
                } else {
                    itemsList.innerHTML = snapshot.docs.slice(0, 10).map(doc => {
                        const d = doc.data();
                        const tipoBadge = d.tipo === 'KAIZEN'
                            ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded">KAIZEN</span>'
                            : '<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs font-semibold rounded">DESV√çO</span>';

                        const estadoBadge = d.estado === 'ABIERTO'
                            ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded">ABIERTO</span>'
                            : '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">CERRADO</span>';

                        const fecha = toDate(d.fecha_creacion);
                        const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });

                        return `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-orange-500 hover:shadow-md transition-all cursor-pointer" 
                         onclick='${d.tipo === "KAIZEN" ? `openKaizenModal("${doc.id}")` : `openDesvioModal("${doc.id}")`}'>
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex gap-2">
                                ${tipoBadge}
                                ${estadoBadge}
                            </div>
                            <span class="text-xs text-gray-500">${fechaFormateada}</span>
                        </div>
                        <p class="text-gray-800 text-sm line-clamp-2">${d.descripcion}</p>
                        ${d.resolucion_estado ? `<p class="text-xs text-gray-600 mt-1">Resoluci√≥n: ${d.resolucion_estado}</p>` : ''}
                    </div>
                `;
                    }).join('');
                }

            } catch (error) {
                console.error('Error loading OLA analytics:', error);
                document.getElementById('ola-analytics-content').innerHTML = `
            <div class="text-center py-12">
                <div class="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Error cargando an√°lisis</h3>
                <p class="text-gray-600">No se pudieron cargar los datos para ${ola}</p>
                <button onclick="loadOLAAnalytics('${ola}')" class="mt-4 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">
                    Reintentar
                </button>
            </div>
        `;
            }
        }
        function enhanceModalsWithFileLinks() {
            const fileLinkHTML = `
        <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <label class="block text-sm font-semibold text-blue-800 mb-2">
                ‚úÖ Foto de la Soluci√≥n (Opcional)
            </label>
            
            <!-- Input file para foto del despu√©s -->
            <input type="file" id="foto-despues-input" accept="image/*" class="hidden">
            
            <div class="flex gap-2 mb-2">
                <button type="button" onclick="takePhotoDespues()" 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg text-center text-sm">
                    üì∑ Sacar Foto
                </button>
                <button type="button" onclick="chooseFromGalleryDespues()" 
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded-lg text-center text-sm">
                    üñºÔ∏è Galer√≠a
                </button>
            </div>
            
            <!-- Vista previa -->
            <div id="foto-despues-preview" class="hidden mt-2 text-center">
                <img id="foto-despues-preview-img" class="max-w-full rounded-lg shadow-md mx-auto max-h-32">
                <button type="button" onclick="removePhotoDespues()" 
                        class="mt-1 bg-red-600 hover:bg-red-700 text-white text-xs px-2 py-1 rounded">
                    ‚ùå Eliminar
                </button>
            </div>
            
            <p class="text-xs text-blue-600 mt-2">
                üì∏ Adjunta foto de la soluci√≥n aplicada
            </p>
        </div>
    `;

            // Insertar en formularios de resoluci√≥n si no existen
            const desvioForm = document.getElementById('desvio-resolution-form');
            const kaizenForm = document.getElementById('kaizen-resolution-form');

            if (desvioForm && !desvioForm.querySelector('#foto-despues-input')) {
                desvioForm.insertAdjacentHTML('afterbegin', fileLinkHTML);
            }
            if (kaizenForm && !kaizenForm.querySelector('#foto-despues-input')) {
                kaizenForm.insertAdjacentHTML('afterbegin', fileLinkHTML);
            }

            // Configurar eventos para las nuevas funciones
            setTimeout(() => {
                const input = document.getElementById('foto-despues-input');
                if (input) {
                    input.addEventListener('change', handleFotoDespuesSelect);
                }
            }, 100);
        }

        // Nuevas funciones para foto del "despu√©s"


        function takePhotoDespues() {
            const input = document.getElementById('foto-despues-input');
            input.setAttribute('capture', 'environment');
            input.click();
        }

        function chooseFromGalleryDespues() {
            const input = document.getElementById('foto-despues-input');
            input.removeAttribute('capture');
            input.click();
        }

        function handleFotoDespuesSelect(e) {
            if (e.target.files && e.target.files[0]) {
                currentFotoDespuesFile = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('foto-despues-preview');
                    const img = document.getElementById('foto-despues-preview-img');
                    if (preview && img) {
                        img.src = e.target.result;
                        preview.classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(currentFotoDespuesFile);
            }
        }

        function removePhotoDespues() {
            currentFotoDespuesFile = null;
            document.getElementById('foto-despues-preview').classList.add('hidden');
            document.getElementById('foto-despues-input').value = '';
        }
        // ========== FUNCIONES DE MAPA (desde tu c√≥digo) ==========


        function toggleMapFilters() {
            const filters = document.getElementById('map-filters');
            filters.classList.toggle('hidden');
        }

        async function loadPlantMap() {
            await refreshMapMarkers();
        }

        async function refreshMapMarkers() {
            const desviosRef = getCollectionRef('desvios_kaizen');
            if (!desviosRef) return;

            const snapshot = await desviosRef.get();
            const markersContainer = document.getElementById('map-markers-container');
            markersContainer.innerHTML = '';

            // Get filter states
            const showDesvioAbierto = document.getElementById('filter-map-desvio-abierto').checked;
            const showDesvioCerrado = document.getElementById('filter-map-desvio-cerrado').checked;
            const showKaizenAbierto = document.getElementById('filter-map-kaizen-abierto').checked;
            const showKaizenCerrado = document.getElementById('filter-map-kaizen-cerrado').checked;

            // Group items by coordinates
            const locationGroups = {};
            let totalItems = 0;
            let desviosAbiertos = 0;
            let kaizenAbiertos = 0;
            let cerrados = 0;

            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const id = doc.id;

                // Skip if no coordinates
                if (!data.coordenada_x || !data.coordenada_y) return;

                // Apply filters
                const shouldShow =
                    (data.tipo === 'DESVIO' && data.estado === 'ABIERTO' && showDesvioAbierto) ||
                    (data.tipo === 'DESVIO' && data.estado === 'CERRADO' && showDesvioCerrado) ||
                    (data.tipo === 'KAIZEN' && data.estado === 'ABIERTO' && showKaizenAbierto) ||
                    (data.tipo === 'KAIZEN' && data.estado === 'CERRADO' && showKaizenCerrado);

                if (!shouldShow) return;

                totalItems++;
                if (data.tipo === 'DESVIO' && data.estado === 'ABIERTO') desviosAbiertos++;
                if (data.tipo === 'KAIZEN' && data.estado === 'ABIERTO') kaizenAbiertos++;
                if (data.estado === 'CERRADO') cerrados++;

                const key = `${data.coordenada_x},${data.coordenada_y}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = {
                        x: data.coordenada_x,
                        y: data.coordenada_y,
                        items: []
                    };
                }
                locationGroups[key].items.push({ id, data });
            });

            // Update statistics
            document.getElementById('map-stat-total').textContent = totalItems;
            document.getElementById('map-stat-desvios-abiertos').textContent = desviosAbiertos;
            document.getElementById('map-stat-kaizen-abiertos').textContent = kaizenAbiertos;
            document.getElementById('map-stat-cerrados').textContent = cerrados;

            // Create markers
            Object.values(locationGroups).forEach(location => {
                const marker = document.createElement('div');
                marker.className = 'map-marker';
                marker.style.left = `${location.x}%`;
                marker.style.top = `${location.y}%`;

                // Determine marker color based on first item
                const firstItem = location.items[0].data;
                let markerClass = '';
                if (firstItem.tipo === 'DESVIO' && firstItem.estado === 'ABIERTO') {
                    markerClass = 'marker-desvio-abierto';
                } else if (firstItem.tipo === 'DESVIO' && firstItem.estado === 'CERRADO') {
                    markerClass = 'marker-desvio-cerrado';
                } else if (firstItem.tipo === 'KAIZEN' && firstItem.estado === 'ABIERTO') {
                    markerClass = 'marker-kaizen-abierto';
                } else {
                    markerClass = 'marker-kaizen-cerrado';
                }

                // CAMBIO PRINCIPAL: Mostrar n√∫mero de OLA en lugar de conteo
                const olaNumber = firstItem.ola ? firstItem.ola.replace('OLA ', '') : '?';
                marker.innerHTML = `<div class="marker-dot ${markerClass}">${olaNumber}</div>`;

                marker.onclick = () => showLocationItems(location.items);
                markersContainer.appendChild(marker);
            });

            // Add filter change listeners
            ['filter-map-desvio-abierto', 'filter-map-desvio-cerrado', 'filter-map-kaizen-abierto', 'filter-map-kaizen-cerrado'].forEach(id => {
                document.getElementById(id).onchange = refreshMapMarkers;
            });
        }

        function showLocationItems(items) {
            if (items.length === 1) {
                const item = items[0];
                if (item.data.tipo === 'DESVIO') {
                    openDesvioModal(item.id);
                } else {
                    openKaizenModal(item.id);
                }
            } else {
                // Show selection modal for multiple items
                showMultipleItemsModal(items);
            }
        }

        function showMultipleItemsModal(items) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="modal-backdrop fixed inset-0" onclick="this.parentElement.remove()"></div>
                <div class="flex items-center justify-center min-h-screen px-4 py-8">
                    <div class="relative bg-white rounded-lg shadow-2xl max-w-2xl w-full">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h2 class="text-xl font-bold text-gray-800">Items en esta ubicaci√≥n (${items.length})</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="px-6 py-6 max-h-96 overflow-y-auto space-y-3">
                            ${items.map(item => {
                const tipoBadge = item.data.tipo === 'KAIZEN'
                    ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded">KAIZEN</span>'
                    : '<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs font-semibold rounded">DESV√çO</span>';

                const estadoBadge = item.data.estado === 'ABIERTO'
                    ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded">ABIERTO</span>'
                    : '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">CERRADO</span>';

                return `
                                    <div class="bg-gray-50 p-4 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" onclick='
                                        this.closest(".fixed").remove();
                                        ${item.data.tipo === 'KAIZEN' ? `openKaizenModal("${item.id}")` : `openDesvioModal("${item.id}")`}
                                    '>
                                        <div class="flex items-center gap-2 mb-2">
                                            ${tipoBadge}
                                            ${estadoBadge}
                                            <span class="text-xs text-gray-500">${item.data.ola}</span>
                                        </div>
                                        <p class="text-sm text-gray-800">${item.data.descripcion}</p>
                                        <p class="text-xs text-gray-500 mt-1">${item.data.fecha_creacion ? toDate(item.data.fecha_creacion).toLocaleDateString() : 'N/A'}</p>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function enableMapCoordinateSelection(itemId) {
            mapSelectorMode = true;
            selectedItemForMap = itemId;

            const mapImage = document.getElementById('plant-map-image');
            const markersContainer = document.getElementById('map-markers-container');

            // Limpiar selecci√≥n anterior
            document.querySelectorAll('.coordinate-indicator').forEach(el => el.remove());

            mapImage.classList.add('map-selector-mode');

            // Crear indicador visual
            const indicator = document.createElement('div');
            indicator.className = 'coordinate-indicator';
            indicator.style.display = 'none';
            markersContainer.appendChild(indicator);

            // Mostrar mensaje m√°s claro
            showToast('üéØ Modo selecci√≥n activado: Haz clic en el mapa para guardar la ubicaci√≥n', 'info');

            mapImage.onclick = async function (e) {
                const rect = mapImage.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(2);
                const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(2);

                // Mostrar indicador visual
                indicator.style.left = `${x}%`;
                indicator.style.top = `${y}%`;
                indicator.style.display = 'block';

                try {
                    await getCollectionRef('desvios_kaizen').doc(selectedItemForMap).update({
                        coordenada_x: parseFloat(x),
                        coordenada_y: parseFloat(y)
                    });

                    showToast('üìç Ubicaci√≥n guardada exitosamente! Puedes volver a Entrada de Datos para crear m√°s registros.');

                    // Salir del modo selecci√≥n
                    mapImage.classList.remove('map-selector-mode');
                    mapImage.onclick = null;
                    mapSelectorMode = false;
                    selectedItemForMap = null;

                    // Ocultar indicador despu√©s de un tiempo
                    setTimeout(() => indicator.style.display = 'none', 2000);

                    await refreshMapMarkers();

                } catch (error) {
                    console.error('Error saving coordinates:', error);
                    showToast('‚ùå Error al guardar ubicaci√≥n', 'error');
                }
            };
        }
        function toggleScoreInfo() {
            const infoPanel = document.getElementById('score-info');
            infoPanel.classList.toggle('hidden');
        }
        async function loadRankingTable() {
            const cells = ['C√©lula A', 'C√©lula B', 'C√©lula C'];

            const auditoriasRef = getCollectionRef('auditorias');
            const desviosRef = getCollectionRef('desvios_kaizen');

            if (!auditoriasRef || !desviosRef) {
                document.getElementById('ranking-table').innerHTML = '<div class="text-center py-4 text-red-500">Error de conexi√≥n</div>';
                return;
            }

            try {
                const rankings = await Promise.all(cells.map(async (cell) => {
                    // Mapeo de c√©lula a OLA
                    const olaMap = {
                        'C√©lula A': 'OLA 1',
                        'C√©lula B': 'OLA 2',
                        'C√©lula C': 'OLA 3'
                    };
                    const ola = olaMap[cell];

                    // 1. Puntaje de auditor√≠as SHITSUKE (50% peso)
                    const audSnap = await auditoriasRef
                        .where('auditor_celula', '==', cell)
                        .where('tipo', '==', 'SHITSUKE')
                        .orderBy('fecha', 'desc')
                        .limit(4)
                        .get();

                    const auditScores = audSnap.docs.map(d => d.data().puntaje).filter(v => typeof v === 'number');
                    const auditAvg = auditScores.length ? auditScores.reduce((a, b) => a + b, 0) / auditScores.length : 0;

                    // 2. Eficiencia en cierre de desv√≠os (30% peso)
                    const desviosSnap = await desviosRef
                        .where('ola', '==', ola)
                        .where('tipo', '==', 'DESVIO')
                        .where('estado', '==', 'CERRADO')
                        .get();

                    let efficiencyScore = 100;
                    if (desviosSnap.size > 0) {
                        let totalHours = 0;
                        let count = 0;

                        desviosSnap.docs.forEach(doc => {
                            const data = doc.data();
                            if (data.fecha_cierre && data.fecha_creacion) {
                                totalHours += diffInHours(toDate(data.fecha_cierre), toDate(data.fecha_creacion));
                                count++;
                            }
                        });

                        if (count > 0) {
                            const avgHours = totalHours / count;
                            // Menos de 24h = 100 puntos, m√°s de 72h = 0 puntos
                            efficiencyScore = Math.max(0, 100 - ((avgHours - 24) / 48 * 100));
                        }
                    }

                    // 3. Participaci√≥n en Kaizen (20% peso)
                    const kaizenSnap = await desviosRef
                        .where('ola', '==', ola)
                        .where('tipo', '==', 'KAIZEN')
                        .get();

                    const kaizenCount = kaizenSnap.size;
                    const kaizenScore = Math.min(100, kaizenCount * 20);

                    // Puntuaci√≥n final ponderada
                    const finalScore = (auditAvg * 0.5) + (efficiencyScore * 0.3) + (kaizenScore * 0.2);

                    return {
                        cell,
                        score: finalScore,
                        details: {
                            audit: Math.round(auditAvg),
                            efficiency: Math.round(efficiencyScore),
                            kaizen: Math.round(kaizenScore)
                        }
                    };
                }));

                // Ordenar de mayor a menor puntaje
                rankings.sort((a, b) => b.score - a.score);

                const rankingHTML = rankings.map((rank, index) => `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg ${index === 0 ? 'border-2 border-yellow-400 bg-yellow-50' : ''}">
                <div class="flex items-center gap-4">
                    <span class="text-xl font-bold ${index === 0 ? 'text-yellow-600' : index === 1 ? 'text-gray-500' : 'text-orange-800'}">
                        ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                    </span>
                    <div>
                        <span class="font-semibold text-gray-800 block">${rank.cell}</span>
                        <span class="text-xs text-gray-500">
                            A:${rank.details.audit} | E:${rank.details.efficiency} | K:${rank.details.kaizen}
                        </span>
                    </div>
                </div>
                <span class="font-bold text-lg ${index === 0 ? 'text-yellow-700' : 'text-gray-700'}">
                    ${Math.round(rank.score)} pts
                </span>
            </div>
        `).join('');

                document.getElementById('ranking-table').innerHTML = rankingHTML;

            } catch (error) {
                console.error('Error cargando ranking:', error);
                document.getElementById('ranking-table').innerHTML = '<div class="text-center py-4 text-red-500">Error cargando ranking</div>';
            }
        }
        // AGREGAR: Evitar m√∫ltiples llamadas al cambiar filtros r√°pidamente
        function debouncedRefreshMapMarkers() {
            clearTimeout(refreshTimeout);
            refreshTimeout = setTimeout(refreshMapMarkers, 300);
        }

        // Usar en los filtros: onchange="debouncedRefreshMapMarkers()"
        // AGREGAR: Cache simple para evitar llamadas repetidas

        async function getCachedData(query, key, ttl = 30000) {
            // Limpiar cache expirado
            const now = Date.now();
            Object.keys(dataCache).forEach(cacheKey => {
                if (now - dataCache[cacheKey].timestamp > 300000) { // 5 minutos m√°ximo
                    delete dataCache[cacheKey];
                }
            });

            if (dataCache[key] && now - dataCache[key].timestamp < ttl) {
                console.log(`üì¶ Using cached data for: ${key}`);
                return dataCache[key].data;
            }

            console.log(`üîÑ Fetching fresh data for: ${key}`);
            const data = await query.get();
            dataCache[key] = { data, timestamp: now };
            return data;
        }
        // ========== NUEVAS FUNCIONES PARA ENTRADA DE DATOS ==========

        let currentQuickFormType = '';

        // ========== FUNCIONES PARA EL NUEVO DISE√ëO ==========

        function showQuickForm(tipo) {
            console.log('üîß showQuickForm llamado con:', tipo);
            console.log('üì∏ currentPhotoFile:', currentPhotoFile);

            const container = document.getElementById('quick-form-container');
            const title = document.getElementById('form-title');
            const tipoField = document.getElementById('quick-form-tipo');

            if (!container || !title || !tipoField) {
                console.error('‚ùå Elementos del formulario no encontrados');
                return;
            }

            // RESETEAR TODO - con verificaci√≥n segura
            const form = document.getElementById('quick-desvio-form');
            if (form) form.reset();

            // Resetear foto de manera segura
            if (typeof removePhoto === 'function') {
                removePhoto();
            } else {
                // Fallback si removePhoto no existe
                currentPhotoFile = null;
                const preview = document.getElementById('foto-preview');
                const input = document.getElementById('foto-input');
                if (preview) preview.classList.add('hidden');
                if (input) input.value = '';
            }

            // Configurar seg√∫n el tipo
            if (tipo === 'DESVIO') {
                title.textContent = 'üìù Registrar Nuevo Desv√≠o';
                title.className = 'text-2xl font-bold text-orange-800';
            } else if (tipo === 'KAIZEN') {
                title.textContent = 'üí° Proponer Idea Kaizen';
                title.className = 'text-2xl font-bold text-purple-800';
            }

            tipoField.value = tipo;
            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth' });

            console.log('‚úÖ Formulario mostrado correctamente');
        }
        function hideQuickForm() {
            document.getElementById('quick-form-container').classList.add('hidden');
        }

        // Funci√≥n principal para guardar con ubicaci√≥n
        // Funci√≥n principal para guardar con ubicaci√≥n - VERSI√ìN MEJORADA

        // Modo de guardado en mapa







        // Configuraci√≥n ImgBB - REEMPLAZA CON TU API KEY
        const IMGBB_API_KEY = '7bf0670aa8d5e4e7323ce2a68c5138f7'; // ‚Üê PEGA TU API KEY AQU√ç

        function takePhoto() {
            const input = document.getElementById('foto-input');
            input.setAttribute('capture', 'environment');
            input.click();
        }

        function chooseFromGallery() {
            const input = document.getElementById('foto-input');
            input.removeAttribute('capture');
            input.click();
        }

        // Manejar selecci√≥n de archivo
        document.getElementById('foto-input').addEventListener('change', function (e) {
            if (e.target.files && e.target.files[0]) {
                currentPhotoFile = e.target.files[0];
                showPhotoPreview(currentPhotoFile);
                showToast('‚úÖ Foto cargada. Se guardar√° autom√°ticamente.');
            }
        });

        function showPhotoPreview(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('foto-preview');
                const img = document.getElementById('foto-preview-img');
                img.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            currentPhotoFile = null;
            document.getElementById('foto-preview').classList.add('hidden');
            document.getElementById('foto-input').value = '';
        }

        // Subir foto a ImgBB
        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file.split(',')[1]); // Remover data:image/... del base64

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error('Error en subida a ImgBB');
                }
            } catch (error) {
                console.error('Error subiendo a ImgBB:', error);
                // Fallback: usar Base64 directamente
                return file;
            }
        }

        // Convertir archivo a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        function hideQuickForm() {
            document.getElementById('quick-form-container').classList.add('hidden');
            currentQuickFormType = '';
        }

        // Nuevo manejador de formulario unificado
        // Funci√≥n corregida para manejar el formulario r√°pido
        // Funci√≥n MEJORADA: Guarda todo junto (datos + coordenadas)
        // ========== FUNCIONES PARA GESTI√ìN DE UBICACI√ìN ==========

        function openMapForLocationSelection() {
            // Guardar temporalmente los datos del formulario
            const form = document.getElementById('quick-desvio-form');
            currentFormData = new FormData(form);

            // Cambiar a pesta√±a de mapa
            showTab('mapa-planta');

            // Activar modo selecci√≥n
            setTimeout(() => {
                enableLocationSelectionMode();
                showToast('üó∫Ô∏è Selecciona la ubicaci√≥n en el mapa. Luego vuelve a "Entrada de Datos" para guardar.', 'info');
            }, 500);
        }

        function enableLocationSelectionMode() {
            const mapImage = document.getElementById('plant-map-image');
            const markersContainer = document.getElementById('map-markers-container');

            // Limpiar selecci√≥n anterior
            document.querySelectorAll('.coordinate-indicator').forEach(el => el.remove());

            // Crear indicador visual
            const indicator = document.createElement('div');
            indicator.className = 'coordinate-indicator';
            indicator.style.display = 'none';
            markersContainer.appendChild(indicator);

            mapImage.onclick = function (e) {
                const rect = mapImage.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(2);
                const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(2);

                // Guardar coordenadas
                selectedCoordinates = { x: parseFloat(x), y: parseFloat(y) };

                // Mostrar indicador visual
                indicator.style.left = `${x}%`;
                indicator.style.top = `${y}%`;
                indicator.style.display = 'block';

                // Actualizar texto en el formulario
                updateLocationText(selectedCoordinates);

                showToast(`üìç Ubicaci√≥n seleccionada: X=${x}%, Y=${y}%. Vuelve a Entrada de Datos para guardar.`);

                // Ocultar indicador despu√©s de un tiempo
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            };
        }

        function updateLocationText(coords) {
            const locationText = document.getElementById('selected-coordinates');
            if (locationText) {
                locationText.textContent = `Ubicaci√≥n seleccionada: X=${coords.x}%, Y=${coords.y}%`;
                locationText.className = 'text-xs text-green-600 font-semibold';
            }
        }

        function resetLocationSelection() {
            selectedCoordinates = { x: null, y: null };
            const locationText = document.getElementById('selected-coordinates');
            if (locationText) {
                locationText.textContent = 'No se ha seleccionado ubicaci√≥n';
                locationText.className = 'text-xs text-gray-500';
            }
        }
        function showQuickForm(tipo) {
            // ... c√≥digo existente ...

            // RESETEAR TODO
            document.getElementById('quick-desvio-form').reset();
            resetLocationSelection();
            currentPhotoFile = null; // ‚Üê AGREGAR ESTA L√çNEA
            document.getElementById('foto-preview').classList.add('hidden'); // ‚Üê Y ESTA

            // ... resto del c√≥digo ...
        }
        async function handleQuickFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());

            // Validar que se haya seleccionado ubicaci√≥n para desv√≠os/kaizen
            if ((data.tipo === 'DESVIO' || data.tipo === 'KAIZEN') && (!selectedCoordinates.x || !selectedCoordinates.y)) {
                showToast('‚ùå Primero selecciona una ubicaci√≥n en el mapa', 'error');
                return;
            }

            try {
                if (data.tipo === 'AUDITORIA') {
                    // Guardar auditor√≠a (sin ubicaci√≥n)
                    await getCollectionRef('auditorias').add({
                        ola: data.ola,
                        auditor_celula: data.auditor_celula,
                        tipo: data.tipo_auditoria,
                        puntaje: parseInt(data.puntaje),
                        fecha: firebase.firestore.Timestamp.now()
                    });
                    showToast(`‚úÖ Auditor√≠a de ${data.ola} guardada!`);

                } else {
                    // Guardar desv√≠o/kaizen CON coordenadas
                    const desviosRef = getCollectionRef('desvios_kaizen');
                    await desviosRef.add({
                        tipo: data.tipo,
                        ola: data.ola,
                        descripcion: data.descripcion,
                        estado: 'ABIERTO',
                        fecha_creacion: firebase.firestore.Timestamp.now(),
                        fecha_cierre: null,
                        resolucion_notas: null,
                        resolucion_estado: null,
                        coordenada_x: selectedCoordinates.x,
                        coordenada_y: selectedCoordinates.y  // <- Coordenadas guardadas aqu√≠
                    });

                    showToast(`‚úÖ ${data.tipo === 'DESVIO' ? 'Desv√≠o' : 'Idea Kaizen'} guardado con ubicaci√≥n!`);
                }

                // Limpiar y cerrar
                form.reset();
                resetLocationSelection();
                hideQuickForm();

                // Actualizar vistas
                loadOpenDesvios();
                loadRecentAudits();
                if (data.tipo !== 'AUDITORIA') {
                    loadEfficiencyKPIs();
                    refreshMapMarkers(); // Actualizar mapa con nuevo marcador
                }

            } catch (error) {
                console.error("Error guardando registro:", error);
                showToast("‚ùå Error al guardar registro", 'error');
            }
        }
        // Funci√≥n para manejar la selecci√≥n de mapa desde el formulario r√°pido
        function setupQuickMapSelection() {
            const btnSelectMap = document.getElementById('quick-btn-select-map');
            if (btnSelectMap) {
                btnSelectMap.addEventListener('click', function () {
                    const itemId = this.dataset.itemId;
                    if (!itemId) {
                        showToast('Primero guarda el registro antes de seleccionar ubicaci√≥n.', 'error');
                        return;
                    }

                    // Ocultar el formulario pero mantener los datos
                    hideQuickForm();

                    // Cambiar a pesta√±a de mapa y activar selecci√≥n
                    showTab('mapa-planta');
                    setTimeout(() => {
                        enableMapCoordinateSelection(itemId);
                        showToast('Haz clic en el mapa para seleccionar la ubicaci√≥n. Despu√©s podr√°s volver a completar el formulario.', 'info');
                    }, 500);
                });
            }
        }
        // Cargar auditor√≠as recientes
        async function loadRecentAudits() {
            const container = document.getElementById('recent-audits');
            try {
                const snapshot = await getCollectionRef('auditorias')
                    .orderBy('fecha', 'desc')
                    .limit(5)
                    .get();

                if (snapshot.empty) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-500">No hay auditor√≠as recientes</div>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const fecha = toDate(data.fecha).toLocaleDateString();

                    let colorClass = 'bg-red-100 text-red-800';
                    if (data.puntaje >= 90) colorClass = 'bg-green-100 text-green-800';
                    else if (data.puntaje >= 75) colorClass = 'bg-yellow-100 text-yellow-800';

                    return `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold text-gray-800">${data.ola}</span>
                            <span class="text-xs text-gray-500">‚Ä¢</span>
                            <span class="text-sm text-gray-600">${data.auditor_celula}</span>
                        </div>
                        <p class="text-sm text-gray-700">${data.tipo} - ${fecha}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${colorClass}">
                        ${data.puntaje} pts
                    </span>
                </div>
            `;
                }).join('');

            } catch (error) {
                console.error('Error loading recent audits:', error);
                container.innerHTML = '<div class="text-center py-4 text-red-500">Error cargando auditor√≠as</div>';
            }
        }

        // Actualizar loadOpenDesvios para incluir contador
        window.loadOpenDesvios = async function () {
            const container = document.getElementById('open-desvios');
            const countElement = document.getElementById('open-desvios-count');

            try {
                const snapshot = await getCollectionRef('desvios_kaizen')
                    .where('tipo', '==', 'DESVIO')
                    .where('estado', '==', 'ABIERTO')
                    .get();

                countElement.textContent = `${snapshot.size} desv√≠os`;

                if (snapshot.empty) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">üéâ No hay desv√≠os abiertos</div>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const id = doc.id;
                    const date = d.fecha_creacion ? toDate(d.fecha_creacion).toLocaleDateString() : 'N/A';

                    return `
                <div class="flex flex-col md:flex-row md:items-center justify-between p-4 bg-orange-50 border border-orange-200 rounded-lg">
                    <div class="flex-1 mb-3 md:mb-0">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-semibold text-orange-800">${d.ola}</span>
                            <span class="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded">Desv√≠o</span>
                        </div>
                        <p class="text-gray-800">${d.descripcion}</p>
                        <p class="text-xs text-gray-500 mt-1">Creado: ${date}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openDesvioModal('${id}')" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            üëÅÔ∏è Ver
                        </button>
                        <button onclick="closeDesvio('${id}')" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                            ‚úÖ Cerrar
                        </button>
                    </div>
                </div>
            `;
                }).join('');

            } catch (err) {
                console.error('Error loading open desvios:', err);
                container.innerHTML = '<div class="text-center py-4 text-red-500">Error al cargar desv√≠os</div>';
                countElement.textContent = 'Error';
            }
        };
        // ========== VARIABLES SIMPLES ==========


        // ========== FUNCI√ìN PRINCIPAL MEJORADA ==========

        // ========== MODO GUARDADO EN MAPA ==========

        // ========== FUNCIONES DE FOTOS ==========
        function takePhoto() {
            const input = document.getElementById('foto-input');
            input.setAttribute('capture', 'environment');
            input.click();
        }

        function chooseFromGallery() {
            const input = document.getElementById('foto-input');
            input.removeAttribute('capture');
            input.click();
        }
        function enableMapSaveMode() {
            console.log('üó∫Ô∏è Activando modo guardado en mapa...');
            console.log('üì¶ DATOS A GUARDAR:', pendingFormData); // DEBUG

            const mapImage = document.getElementById('plant-map-image');
            const markersContainer = document.getElementById('map-markers-container');

            if (!mapImage || !markersContainer) {
                showToast('‚ùå Error: Mapa no disponible', 'error');
                return;
            }

            // Limpiar selecciones anteriores
            document.querySelectorAll('.coordinate-indicator').forEach(el => el.remove());

            // Crear indicador
            const indicator = document.createElement('div');
            indicator.className = 'coordinate-indicator';
            indicator.style.display = 'none';
            markersContainer.appendChild(indicator);

            mapImage.onclick = async function (e) {
                if (!pendingFormData) {
                    showToast('‚ùå Error: Datos no disponibles', 'error');
                    return;
                }

                const rect = mapImage.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(2);
                const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(2);

                // Mostrar indicador
                indicator.style.left = `${x}%`;
                indicator.style.top = `${y}%`;
                indicator.style.display = 'block';

                try {
                    // GUARDAR DIRECTAMENTE en Firestore
                    const desviosRef = getCollectionRef('desvios_kaizen');

                    // üéØ DATOS BASE
                    const registroData = {
                        tipo: pendingFormData.tipo,
                        ola: pendingFormData.ola,
                        descripcion: pendingFormData.descripcion,
                        estado: 'ABIERTO',
                        fecha_creacion: firebase.firestore.Timestamp.now(),
                        fecha_cierre: null,
                        resolucion_notas: null,
                        resolucion_estado: null,
                        coordenada_x: parseFloat(x),
                        coordenada_y: parseFloat(y)
                    };

                    // üéØ AGREGAR DATOS ESPEC√çFICOS DE KAIZEN SI EXISTEN
                    if (pendingFormData.tipo === 'KAIZEN') {
                        console.log('üîß AGREGANDO CAMPOS KAIZEN AL REGISTRO...');

                        // Agregar campos espec√≠ficos de Kaizen
                        registroData.necesita_compra = pendingFormData.necesita_compra || 'no';
                        registroData.beneficio_principal = pendingFormData.beneficio_principal || 'otro';

                        // Agregar materiales solo si necesita compra
                        if (pendingFormData.necesita_compra === 'si') {
                            registroData.materiales = pendingFormData.materiales || '';
                            registroData.costo_aproximado = pendingFormData.costo_aproximado || 'poco';
                        }

                        console.log('üì¶ REGISTRO KAIZEN COMPLETO:', registroData);
                    }

                    // Agregar foto si existe
                    if (pendingFormData.foto_antes) {
                        registroData.foto_antes = pendingFormData.foto_antes;
                        registroData.tiene_foto = true;
                    }

                    // üéØ GUARDAR EN FIRESTORE
                    console.log('üíæ GUARDANDO EN FIRESTORE:', registroData);
                    const result = await desviosRef.add(registroData);
                    console.log('‚úÖ REGISTRO GUARDADO CON ID:', result.id);

                    // √âXITO
                    const mensaje = pendingFormData.foto_antes ?
                        `‚úÖ ${pendingFormData.tipo === 'DESVIO' ? 'Desv√≠o' : 'Idea Kaizen'} guardado con foto y ubicaci√≥n!` :
                        `‚úÖ ${pendingFormData.tipo === 'DESVIO' ? 'Desv√≠o' : 'Idea Kaizen'} guardado con ubicaci√≥n!`;

                    showToast(mensaje);

                    // Limpiar TODO
                    pendingFormData = null;
                    removePhoto();
                    hideQuickForm();

                    // Actualizar vistas y volver
                    setTimeout(() => {
                        showTab('data-entry');
                        loadOpenDesvios();
                        loadEfficiencyKPIs();
                        refreshMapMarkers();
                    }, 1000);

                } catch (error) {
                    console.error("‚ùå Error guardando:", error);
                    showToast("‚ùå Error al guardar registro", 'error');
                }

                // Limpiar evento
                mapImage.onclick = null;
            };
        }
        // Manejar selecci√≥n de archivo
        document.getElementById('foto-input').addEventListener('change', function (e) {
            if (e.target.files && e.target.files[0]) {
                currentPhotoFile = e.target.files[0];
                showPhotoPreview(currentPhotoFile);
                showToast('‚úÖ Foto cargada. Se guardar√° autom√°ticamente.');
            }
        });

        function showPhotoPreview(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('foto-preview');
                const img = document.getElementById('foto-preview-img');
                if (preview && img) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                }
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            currentPhotoFile = null;
            const preview = document.getElementById('foto-preview');
            const input = document.getElementById('foto-input');
            if (preview) preview.classList.add('hidden');
            if (input) input.value = '';
        }

        // Subir foto a ImgBB
        async function uploadToImgBB(base64String) {
            // Remover el prefijo data:image/... del base64
            const base64Data = base64String.split(',')[1];

            const formData = new FormData();
            formData.append('image', base64Data);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error('Error en subida a ImgBB');
                }
            } catch (error) {
                console.error('Error subiendo a ImgBB:', error);
                // Fallback: usar Base64 directamente (para desarrollo)
                return base64String;
            }
        }

        // Convertir archivo a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        // Funci√≥n para mostrar foto en modal
        // Funci√≥n para mostrar foto en modal - VERSI√ìN CORREGIDA
        // Funci√≥n CORREGIDA para mostrar foto en modal - SOLO LA FOTO DEL REGISTRO ACTUAL
        function showPhotoInModal(modalType, data) {
            const descripcionElement = document.getElementById(`${modalType}-modal-descripcion`);
            if (!descripcionElement) return;

            const descripcionParent = descripcionElement.parentElement;
            if (!descripcionParent) return;

            // Limpiar TODAS las fotos anteriores del modal
            const existingFotos = descripcionParent.querySelectorAll('.foto-container');
            existingFotos.forEach(foto => foto.remove());

            // Mostrar SOLO la foto del registro actual si existe
            if (data.foto_antes && data.foto_antes.trim() !== '') {
                const fotoContainer = document.createElement('div');
                fotoContainer.className = 'foto-container mt-4 p-3 bg-green-50 rounded-lg border border-green-200';

                // Escapar comillas simples para evitar errores en el onclick
                const safeUrl = data.foto_antes.replace(/'/g, "\\'");

                fotoContainer.innerHTML = `
            <p class="text-sm font-semibold text-green-800 mb-2">üì∏ Foto del Problema</p>
            <img src="${data.foto_antes}" 
                 class="max-w-full rounded-lg shadow-md max-h-48 mx-auto cursor-pointer"
                 onclick="openFullSizeImage('${safeUrl}')">
            <p class="text-xs text-green-600 mt-2 text-center">Haz clic para ampliar</p>
        `;

                descripcionParent.insertBefore(fotoContainer, descripcionElement.nextSibling);
            }
        }

        // Funci√≥n para ver imagen completa
        function openFullSizeImage(url) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-black bg-opacity-90 flex items-center justify-center p-4';
            modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <img src="${url}" class="max-w-full max-h-full rounded-lg">
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="absolute top-4 right-4 text-white text-2xl bg-red-600 rounded-full w-10 h-10 flex items-center justify-center">
                ‚úï
            </button>
        </div>
    `;
            document.body.appendChild(modal);
        }
        // ========== FUNCIONES DE FOTOS ==========
        function takePhoto() {
            const input = document.getElementById('foto-input');
            if (input) {
                input.setAttribute('capture', 'environment');
                input.click();
            }
        }

        function chooseFromGallery() {
            const input = document.getElementById('foto-input');
            if (input) {
                input.removeAttribute('capture');
                input.click();
            }
        }

        // Manejar selecci√≥n de archivo
        document.addEventListener('DOMContentLoaded', function () {
            const fotoInput = document.getElementById('foto-input');
            if (fotoInput) {
                fotoInput.addEventListener('change', function (e) {
                    if (e.target.files && e.target.files[0]) {
                        currentPhotoFile = e.target.files[0];
                        showPhotoPreview(currentPhotoFile);
                        showToast('‚úÖ Foto cargada. Se guardar√° autom√°ticamente.');
                    }
                });
            }
        });

        function showPhotoPreview(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('foto-preview');
                const img = document.getElementById('foto-preview-img');
                if (preview && img) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                }
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            currentPhotoFile = null;
            const preview = document.getElementById('foto-preview');
            const input = document.getElementById('foto-input');
            if (preview) preview.classList.add('hidden');
            if (input) input.value = '';
        }

        // Subir foto a ImgBB
        async function uploadToImgBB(base64String) {
            if (!IMGBB_API_KEY || IMGBB_API_KEY === 'tu_api_key_de_imgbb_aqui') {
                console.warn('‚ö†Ô∏è API Key de ImgBB no configurada. Usando base64.');
                return base64String; // Fallback para desarrollo
            }

            const base64Data = base64String.split(',')[1];
            const formData = new FormData();
            formData.append('image', base64Data);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error('Error en subida a ImgBB');
                }
            } catch (error) {
                console.error('Error subiendo a ImgBB:', error);
                return base64String; // Fallback
            }
        }

        // Convertir archivo a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Funci√≥n para mostrar foto en modal

        // Funci√≥n para ver imagen completa
        function openFullSizeImage(url) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-black bg-opacity-90 flex items-center justify-center p-4';
            modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <img src="${url}" class="max-w-full max-h-full rounded-lg">
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="absolute top-4 right-4 text-white text-2xl bg-red-600 rounded-full w-10 h-10 flex items-center justify-center">
                ‚úï
            </button>
        </div>
    `;
            document.body.appendChild(modal);
        }
        // ========== FUNCIONES PARA EL NUEVO DISE√ëO ==========
        function showQuickForm(tipo) {
            console.log('üéØ Mostrando formulario para:', tipo);

            const container = document.getElementById('quick-form-container');
            const title = document.getElementById('form-title');
            const tipoField = document.getElementById('quick-form-tipo');

            if (!container || !title || !tipoField) {
                console.error('‚ùå Elementos del formulario no encontrados');
                showToast('Error: No se pudo cargar el formulario', 'error');
                return;
            }

            // RESETEAR TODO
            const form = document.getElementById('quick-desvio-form');
            if (form) form.reset();

            removePhoto();

            // Configurar seg√∫n el tipo
            if (tipo === 'DESVIO') {
                title.textContent = 'üìù Registrar Nuevo Desv√≠o';
                title.className = 'text-2xl font-bold text-orange-800';
            } else if (tipo === 'KAIZEN') {
                title.textContent = 'üí° Proponer Idea Kaizen';
                title.className = 'text-2xl font-bold text-purple-800';
            }

            tipoField.value = tipo;
            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth' });

            console.log('‚úÖ Formulario mostrado correctamente');
        }

        function hideQuickForm() {
            const container = document.getElementById('quick-form-container');
            if (container) {
                container.classList.add('hidden');
            }
        }

        // Funci√≥n principal para guardar con ubicaci√≥n

        async function saveWithLocation() {
            console.log('üíæ Iniciando guardado con ubicaci√≥n...');

            const form = document.getElementById('quick-desvio-form');
            if (!form) {
                showToast('‚ùå Error: Formulario no encontrado', 'error');
                return;
            }

            const data = Object.fromEntries(new FormData(form).entries());
            console.log('üìù DATOS DEL FORMULARIO:', data); // DEBUG

            // Validaciones b√°sicas
            if (!data.ola || !data.descripcion) {
                showToast('‚ùå Completa OLA y descripci√≥n primero', 'error');
                return;
            }

            // SUBIR FOTO SI EXISTE
            let fotoUrl = null;
            if (currentPhotoFile) {
                showToast('üì∏ Subiendo foto...');
                try {
                    const base64String = await fileToBase64(currentPhotoFile);
                    fotoUrl = await uploadToImgBB(base64String);
                    showToast('‚úÖ Foto subida correctamente');
                } catch (error) {
                    console.error('Error subiendo foto:', error);
                    showToast('‚ö†Ô∏è Foto no se pudo subir, pero el registro se guardar√°');
                }
            }

            // üéØ PREPARAR DATOS ADICIONALES PARA KAIZEN - VERSI√ìN MEJORADA
            let datosAdicionales = {};
            if (data.tipo === 'KAIZEN') {
                console.log('üîß PROCESANDO DATOS KAIZEN...');

                datosAdicionales = {
                    necesita_compra: data.necesita_compra || 'no',
                    beneficio_principal: data.beneficio_principal || 'otro'
                };

                console.log('üì¶ DATOS KAIZEN PREPARADOS:', datosAdicionales);

                // Solo agregar materiales si necesita compra
                if (data.necesita_compra === 'si') {
                    datosAdicionales.materiales = data.materiales || '';
                    datosAdicionales.costo_aproximado = data.costo_aproximado || 'poco';
                    console.log('üì¶ MATERIALES AGREGADOS:', datosAdicionales);
                }
            }

            // üéØ GUARDAR TODOS LOS DATOS JUNTOS
            pendingFormData = {
                ...data,
                foto_antes: fotoUrl,
                ...datosAdicionales  // ‚Üê ¬°ESTO ES CLAVE!
            };

            console.log('üì¶ PENDING FORM DATA COMPLETO:', pendingFormData);

            // Ir al mapa para seleccionar ubicaci√≥n
            showTab('mapa-planta');
            setTimeout(() => {
                enableMapSaveMode();
                showToast('üó∫Ô∏è Haz clic en el mapa para guardar TODO');
            }, 500);
        }
        // Modo de guardado en mapa

        // ========== FUNCIONES PARA MAPA MEJORADO ==========

        // Cambiar imagen del mapa seg√∫n OLA seleccionada
        function changePlantMap(ola) {
            const mapImage = document.getElementById('plant-map-image');
            let imageUrl = '';

            switch (ola) {
                case 'all':
                    imageUrl = './planta-todas.png';
                    break;
                case 'OLA 1':
                    imageUrl = './planta-ola1.png';
                    break;
                case 'OLA 2':
                    imageUrl = './planta-ola2.png';
                    break;
                case 'OLA 3':
                    imageUrl = './planta-ola3.png';
                    break;
                default:
                    imageUrl = './planta-todas.png';
            }

            // Mostrar carga mientras cambia la imagen
            mapImage.style.opacity = '0.5';

            // Precargar imagen
            const newImage = new Image();
            newImage.onload = function () {
                mapImage.src = imageUrl;
                mapImage.style.opacity = '1';
                // Actualizar marcadores para la OLA seleccionada
                refreshMapMarkers();
            };
            newImage.onerror = function () {
                // Fallback si la imagen espec√≠fica no existe
                mapImage.src = './planta-todas.png';
                mapImage.style.opacity = '1';
                showToast('Imagen espec√≠fica no encontrada, mostrando vista general', 'info');
            };
            newImage.src = imageUrl;
        }

        // Funci√≥n mejorada para filtrar marcadores por OLA
        async function refreshMapMarkers() {
            const desviosRef = getCollectionRef('desvios_kaizen');
            if (!desviosRef) return;

            const snapshot = await desviosRef.get();
            const markersContainer = document.getElementById('map-markers-container');
            markersContainer.innerHTML = '';

            // Get filter states
            const selectedOla = document.querySelector('input[name="ola-filter"]:checked').value;
            const showDesvioAbierto = document.getElementById('filter-map-desvio-abierto').checked;
            const showDesvioCerrado = document.getElementById('filter-map-desvio-cerrado').checked;
            const showKaizenAbierto = document.getElementById('filter-map-kaizen-abierto').checked;
            const showKaizenCerrado = document.getElementById('filter-map-kaizen-cerrado').checked;

            // Group items by coordinates
            const locationGroups = {};
            let totalItems = 0;
            let desviosAbiertos = 0;
            let kaizenAbiertos = 0;
            let cerrados = 0;

            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const id = doc.id;

                // Skip if no coordinates
                if (!data.coordenada_x || !data.coordenada_y) return;

                // Apply OLA filter
                if (selectedOla !== 'all' && data.ola !== selectedOla) return;

                // Apply type filters
                const shouldShow =
                    (data.tipo === 'DESVIO' && data.estado === 'ABIERTO' && showDesvioAbierto) ||
                    (data.tipo === 'DESVIO' && data.estado === 'CERRADO' && showDesvioCerrado) ||
                    (data.tipo === 'KAIZEN' && data.estado === 'ABIERTO' && showKaizenAbierto) ||
                    (data.tipo === 'KAIZEN' && data.estado === 'CERRADO' && showKaizenCerrado);

                if (!shouldShow) return;

                totalItems++;
                if (data.tipo === 'DESVIO' && data.estado === 'ABIERTO') desviosAbiertos++;
                if (data.tipo === 'KAIZEN' && data.estado === 'ABIERTO') kaizenAbiertos++;
                if (data.estado === 'CERRADO') cerrados++;

                const key = `${data.coordenada_x},${data.coordenada_y}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = {
                        x: data.coordenada_x,
                        y: data.coordenada_y,
                        items: []
                    };
                }
                locationGroups[key].items.push({ id, data });
            });

            // Update statistics
            document.getElementById('map-stat-total').textContent = totalItems;
            document.getElementById('map-stat-desvios-abiertos').textContent = desviosAbiertos;
            document.getElementById('map-stat-kaizen-abiertos').textContent = kaizenAbiertos;
            document.getElementById('map-stat-cerrados').textContent = cerrados;

            // Create markers
            Object.values(locationGroups).forEach(location => {
                const marker = document.createElement('div');
                marker.className = 'map-marker';
                marker.style.left = `${location.x}%`;
                marker.style.top = `${location.y}%`;

                // Determine marker color based on first item
                const firstItem = location.items[0].data;
                let markerClass = '';
                let markerText = '';

                if (firstItem.tipo === 'DESVIO' && firstItem.estado === 'ABIERTO') {
                    markerClass = 'marker-desvio-abierto';
                    markerText = '!';
                } else if (firstItem.tipo === 'DESVIO' && firstItem.estado === 'CERRADO') {
                    markerClass = 'marker-desvio-cerrado';
                    markerText = '‚úì';
                } else if (firstItem.tipo === 'KAIZEN' && firstItem.estado === 'ABIERTO') {
                    markerClass = 'marker-kaizen-abierto';
                    markerText = 'üí°';
                } else {
                    markerClass = 'marker-kaizen-cerrado';
                    markerText = '‚úì';
                }

                marker.innerHTML = `<div class="marker-dot ${markerClass}">${markerText}</div>`;

                marker.onclick = () => showLocationItems(location.items);
                markersContainer.appendChild(marker);
            });
        }

        // Mostrar/ocultar filtros
        function toggleMapFilters() {
            const filters = document.getElementById('map-filters');
            filters.classList.toggle('hidden');
        }
        // ========== FUNCIONES PARA FORMULARIO MEJORADO ==========

        // Mostrar/ocultar secci√≥n de materiales seg√∫n selecci√≥n
        function toggleMaterialInfo(valor) {
            const materialInfo = document.getElementById('material-info');
            if (valor === 'si') {
                materialInfo.classList.remove('hidden');
            } else {
                materialInfo.classList.add('hidden');
            }
        }

        // Funci√≥n mejorada para mostrar formulario
        function showQuickForm(tipo) {
            console.log('üîß showQuickForm llamado con:', tipo);

            const container = document.getElementById('quick-form-container');
            const title = document.getElementById('form-title');
            const tipoField = document.getElementById('quick-form-tipo');
            const kaizenCostSection = document.getElementById('kaizen-cost-section');

            if (!container || !title || !tipoField) {
                console.error('‚ùå Elementos del formulario no encontrados');
                showToast('Error: No se pudo cargar el formulario', 'error');
                return;
            }

            // RESETEAR TODO
            const form = document.getElementById('quick-desvio-form');
            if (form) form.reset();

            removePhoto();

            // Configurar seg√∫n el tipo
            if (tipo === 'DESVIO') {
                title.textContent = 'üìù Registrar Nuevo Desv√≠o';
                title.className = 'text-2xl font-bold text-orange-800';
                kaizenCostSection.classList.add('hidden');
            } else if (tipo === 'KAIZEN') {
                title.textContent = 'üí° Proponer Idea Kaizen';
                title.className = 'text-2xl font-bold text-purple-800';
                kaizenCostSection.classList.remove('hidden');

                // Resetear secci√≥n de materiales
                document.getElementById('material-info').classList.add('hidden');
                document.getElementById('necesita-compra').value = 'no';
            }

            tipoField.value = tipo;
            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth' });

            console.log('‚úÖ Formulario mostrado correctamente');
        }
        // ---------- Inicializaci√≥n ----------
        //window.addEventListener('load', initFirebase);
    </script>
</body>

</html>